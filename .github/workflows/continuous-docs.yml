name: ğŸ“š Continuous Documentation

on:
  pull_request:
    types: [opened, synchronize]
    paths:
      - "**/*.js"
      - "**/*.ts"
      - "**/*.py"
      - "**/*.go"
      - "**/*.java"
      - "**/*.cs"
      - "**/*.rb"
      - "**/*.rs"
      - "**/*.php"
      - "**/*.swift"
      - "**/*.kt"
      - "**/*.sh"
      - "**/*.yml"
      - "**/*.yaml"
      - "**/*.json"
  workflow_call:
    inputs:
      pr_number:
        description: 'Pull request number'
        required: true
        type: string
      pr_title:
        description: 'Pull request title'
        required: true
        type: string
      pr_author:
        description: 'Pull request author login'
        required: true
        type: string
      base_ref:
        description: 'Base branch of the PR'
        required: true
        type: string
      head_ref:
        description: 'Head branch of the PR'
        required: true
        type: string
    secrets:
      COPILOT_PAT:
        required: true

permissions:
  contents: write
  pull-requests: write

jobs:
  continuous-docs:
    name: ğŸ“š Check & Improve Documentation
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout PR branch
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ inputs.head_ref || github.event.pull_request.head.ref }}
          token: ${{ secrets.COPILOT_PAT }}

      - name: ğŸ“¦ Install GitHub Copilot CLI
        run: |
          curl -fsSL https://gh.io/copilot-install | bash
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: ğŸ“š Analyze code changes and documentation drift
        env:
          GH_TOKEN: ${{ secrets.COPILOT_PAT }}
          PR_NUMBER: ${{ inputs.pr_number || github.event.pull_request.number }}
          PR_TITLE: ${{ inputs.pr_title || github.event.pull_request.title }}
          PR_AUTHOR: ${{ inputs.pr_author || github.event.pull_request.user.login }}
          BASE_REF: ${{ inputs.base_ref || github.event.pull_request.base.ref }}
          HEAD_REF: ${{ inputs.head_ref || github.event.pull_request.head.ref }}
        run: |
          export PATH="$HOME/.local/bin:$PATH"

          copilot -p "
          You are an expert Continuous Documentation assistant for the repository '${{ github.repository }}'.
          Your job is to analyze code changes in a pull request, detect documentation drift,
          suggest README and API doc improvements, and nudge the PR author when explanations
          no longer match the actual implementation.

          PULL REQUEST DETAILS:
          - Number: #$PR_NUMBER
          - Title: $PR_TITLE
          - Author: @$PR_AUTHOR
          - Base branch: $BASE_REF
          - Head branch: $HEAD_REF

          Follow these steps IN ORDER:

          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          STEP 1 â€” UNDERSTAND THE PROJECT
          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          - Read the repository README (and any localized versions like README.es.md) to understand
            what this project is about and what it documents.
          - Read AGENTS.md or CONTRIBUTING.md if they exist.
          - Scan the project structure to identify where documentation lives:
            README files, docs/ folder, API docs, JSDoc/docstrings, inline comments, etc.

          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          STEP 2 â€” ANALYZE THE PR CHANGES
          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          - Use the GitHub MCP Server to get the full diff of PR #$PR_NUMBER.
          - Identify ALL files changed, added, or deleted.
          - Categorize the changes:
            a) New features or public APIs added
            b) Existing features or APIs modified (signature changes, behavior changes)
            c) Features or APIs removed/deprecated
            d) Configuration changes (env vars, settings, dependencies)
            e) Workflow or CI/CD changes
            f) Structural changes (files renamed, moved, or reorganized)

          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          STEP 3 â€” DETECT DOCUMENTATION DRIFT
          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          For each change identified in Step 2, check whether existing documentation
          still accurately describes the code. Look for:

          a) **README drift**:
             - Does the README mention features, commands, APIs, or file paths that have changed?
             - Does the project structure section match the actual file tree?
             - Are installation or usage instructions still correct?
             - Are config examples or environment variable lists still accurate?

          b) **API / docstring drift**:
             - Have function signatures changed without updating their docstrings/JSDoc/type hints?
             - Have parameters been added, removed, or renamed without updating documentation?
             - Have return types or error behaviors changed?

          c) **Inline comment drift**:
             - Are there comments that describe logic which no longer matches the code below them?
             - Are TODO/FIXME/HACK comments that are now resolved but still present?

          d) **Config & dependency drift**:
             - Have new dependencies been added without documenting them in prerequisites?
             - Have environment variables changed without updating .env.example or the README?

          e) **Missing documentation for new code**:
             - New public functions/classes/endpoints without any documentation
             - New workflows or scripts without usage instructions
             - New config options without explanation

          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          STEP 4 â€” FIX DOCUMENTATION DIRECTLY
          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          For each drift or gap found, EDIT THE FILES DIRECTLY in the working directory:

          a) **README drift**: Edit README.md (and localized versions like README.es.md)
             to fix outdated sections â€” project structure, feature lists, usage instructions,
             config examples, environment variable references, etc.

          b) **API / docstring drift**: Edit the source files to update docstrings, JSDoc,
             type hints, or inline comments so they match the new code behavior.

          c) **Stale comments**: Remove or update TODO/FIXME/HACK comments that are now resolved.

          d) **Config & dependency docs**: Update .env.example, prerequisites sections,
             or setup instructions to reflect new dependencies or config changes.

          e) **Missing documentation for new code**: Add docstrings, README sections,
             or usage instructions for newly added public APIs, workflows, or scripts.

          Prioritize edits by impact:
            ğŸ”´ Critical â€” documentation is actively misleading (wrong instructions, wrong API)
            ğŸŸ¡ Important â€” documentation is incomplete or stale but not harmful
            ğŸŸ¢ Nice to have â€” minor wording improvements, typo fixes, clarity enhancements

          Focus on ğŸ”´ and ğŸŸ¡ items. Only fix ğŸŸ¢ items if there are few total changes.

          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          STEP 5 â€” COMMIT AND PUSH CHANGES
          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          After editing the files, use the GitHub MCP Server to push the changes
          to the HEAD branch of the PR ($HEAD_REF) with a commit message like:

            ğŸ“š docs: update documentation to match code changes

          Only commit files that you actually modified. If no documentation drift was found,
          DO NOT create an empty commit.

          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          STEP 6 â€” LEAVE A SUMMARY COMMENT
          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          Use the GitHub MCP Server to add a SHORT comment on PR #$PR_NUMBER:

          - If you made changes:
            > ğŸ“š **Documentation updated!**
            >
            > I detected documentation drift and pushed a commit to fix it:
            > - (list each file changed and a one-line summary of what was updated)
            >
            > Please review the changes and adjust if needed.
            >
            > ---
            > ğŸ¤– *Auto-updated by Copilot Continuous Documentation*

          - If everything was already in sync:
            > ğŸ“š **Docs are in sync!** No documentation drift detected for this PR. Great job @$PR_AUTHOR! ğŸ‘

          IMPORTANT GUIDELINES:
          - NEVER change the meaning or intent of existing documentation â€” only fix drift
          - Respect the project's existing documentation style, language, and formatting
          - If the project has docs in multiple languages (e.g. README.md and README.es.md), update ALL of them
          - Only fix documentation issues directly caused by THIS PR's changes
          - Don't rewrite well-written docs â€” make minimal, targeted fixes
          - If the PR already includes correct documentation updates, just confirm they look good
          - Be conservative â€” when in doubt, skip a marginal change rather than risk breaking good docs
          " --allow-all-tools --model claude-opus-4.6

          echo "âœ… Documentation analysis completed for PR #$PR_NUMBER"
