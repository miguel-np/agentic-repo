name: "\uD83D\uDCDA Continuous Documentation"

on:
  pull_request:
    types: [opened, synchronize]
    paths:
      - "**/*.js"
      - "**/*.ts"
      - "**/*.py"
      - "**/*.go"
      - "**/*.java"
      - "**/*.cs"
      - "**/*.rb"
      - "**/*.rs"
      - "**/*.php"
      - "**/*.swift"
      - "**/*.kt"
      - "**/*.sh"
      - "**/*.yml"
      - "**/*.yaml"
      - "**/*.json"
  workflow_call:
    inputs:
      pr_number:
        description: 'Pull request number'
        required: true
        type: string
      pr_title:
        description: 'Pull request title'
        required: true
        type: string
      pr_author:
        description: 'Pull request author login'
        required: true
        type: string
      base_ref:
        description: 'Base branch of the PR'
        required: true
        type: string
      head_ref:
        description: 'Head branch of the PR'
        required: true
        type: string
      author_filter:
        description: 'Who can trigger this workflow: owner_only, collaborators, or all'
        required: false
        type: string
        default: 'owner_only'
      model:
        description: 'Copilot model to use'
        required: false
        type: string
        default: 'claude-sonnet-4'
    secrets:
      COPILOT_PAT:
        required: true

permissions:
  contents: write
  pull-requests: write

jobs:
  continuous-docs:
    name: "\uD83D\uDCDA Check & Improve Documentation"
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: "\uD83D\uDD10 Verify author is allowed"
        id: author_check
        uses: ./.github/actions/check-author
        with:
          author: ${{ inputs.pr_author || github.event.pull_request.user.login }}
          author_filter: ${{ inputs.author_filter || 'owner_only' }}
          repo_owner: ${{ github.repository_owner }}
          repo_full: ${{ github.repository }}
          token: ${{ secrets.COPILOT_PAT || github.token }}

      - name: "\uD83D\uDCE5 Checkout PR branch"
        if: steps.author_check.outputs.allowed == 'true'
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ inputs.head_ref || github.event.pull_request.head.ref }}
          token: ${{ secrets.COPILOT_PAT || github.token }}

      - name: "\uD83D\uDCE6 Install GitHub Copilot CLI"
        if: steps.author_check.outputs.allowed == 'true'
        uses: ./.github/actions/install-copilot

      - name: "\uD83D\uDCDA Analyze code changes and documentation drift"
        if: steps.author_check.outputs.allowed == 'true'
        env:
          GH_TOKEN: ${{ secrets.COPILOT_PAT }}
          PR_NUMBER: ${{ inputs.pr_number || github.event.pull_request.number }}
          PR_AUTHOR: ${{ inputs.pr_author || github.event.pull_request.user.login }}
          HEAD_REF: ${{ inputs.head_ref || github.event.pull_request.head.ref }}
          REPO_NAME: ${{ github.repository }}
          MODEL: ${{ inputs.model || 'claude-sonnet-4' }}
        run: |
          export PATH="$HOME/.local/bin:$PATH"

          PROMPT=$(cat <<'PROMPT_EOF'
          You are an expert Continuous Documentation assistant for the repository.
          Your job is to analyze code changes in a pull request, detect documentation drift,
          suggest README and API doc improvements, and nudge the PR author when explanations
          no longer match the actual implementation.

          Use the GitHub MCP Server to read the full PR details by number ‚Äî do NOT rely
          on any pre-filled title or body text. Fetch the PR fresh from the API.

          Follow these steps IN ORDER:

          ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
          STEP 1 ‚Äî UNDERSTAND THE PROJECT
          ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
          - Read the repository README (and any localized versions like README.es.md) to understand
            what this project is about and what it documents.
          - Read AGENTS.md or CONTRIBUTING.md if they exist.
          - Scan the project structure to identify where documentation lives:
            README files, docs/ folder, API docs, JSDoc/docstrings, inline comments, etc.

          ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
          STEP 2 ‚Äî ANALYZE THE PR CHANGES
          ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
          - Use the GitHub MCP Server to get the full diff of the PR.
          - Identify ALL files changed, added, or deleted.
          - Categorize the changes:
            a) New features or public APIs added
            b) Existing features or APIs modified (signature changes, behavior changes)
            c) Features or APIs removed/deprecated
            d) Configuration changes (env vars, settings, dependencies)
            e) Workflow or CI/CD changes
            f) Structural changes (files renamed, moved, or reorganized)

          ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
          STEP 3 ‚Äî DETECT DOCUMENTATION DRIFT
          ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
          For each change identified in Step 2, check whether existing documentation
          still accurately describes the code. Look for:

          a) **README drift**:
             - Does the README mention features, commands, APIs, or file paths that have changed?
             - Does the project structure section match the actual file tree?
             - Are installation or usage instructions still correct?
             - Are config examples or environment variable lists still accurate?

          b) **API / docstring drift**:
             - Have function signatures changed without updating their docstrings/JSDoc/type hints?
             - Have parameters been added, removed, or renamed without updating documentation?
             - Have return types or error behaviors changed?

          c) **Inline comment drift**:
             - Are there comments that describe logic which no longer matches the code below them?
             - Are TODO/FIXME/HACK comments that are now resolved but still present?

          d) **Config & dependency drift**:
             - Have new dependencies been added without documenting them in prerequisites?
             - Have environment variables changed without updating .env.example or the README?

          e) **Missing documentation for new code**:
             - New public functions/classes/endpoints without any documentation
             - New workflows or scripts without usage instructions
             - New config options without explanation

          ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
          STEP 4 ‚Äî FIX DOCUMENTATION DIRECTLY
          ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
          For each drift or gap found, EDIT THE FILES DIRECTLY in the working directory:

          a) **README drift**: Edit README.md (and localized versions like README.es.md)
             to fix outdated sections ‚Äî project structure, feature lists, usage instructions,
             config examples, environment variable references, etc.

          b) **API / docstring drift**: Edit the source files to update docstrings, JSDoc,
             type hints, or inline comments so they match the new code behavior.

          c) **Stale comments**: Remove or update TODO/FIXME/HACK comments that are now resolved.

          d) **Config & dependency docs**: Update .env.example, prerequisites sections,
             or setup instructions to reflect new dependencies or config changes.

          e) **Missing documentation for new code**: Add docstrings, README sections,
             or usage instructions for newly added public APIs, workflows, or scripts.

          Prioritize edits by impact:
            üî¥ Critical ‚Äî documentation is actively misleading (wrong instructions, wrong API)
            üü° Important ‚Äî documentation is incomplete or stale but not harmful
            üü¢ Nice to have ‚Äî minor wording improvements, typo fixes, clarity enhancements

          Focus on üî¥ and üü° items. Only fix üü¢ items if there are few total changes.

          ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
          STEP 5 ‚Äî COMMIT AND PUSH CHANGES
          ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
          After editing the files, use the GitHub MCP Server to push the changes
          to the HEAD branch of the PR with a commit message like:

            üìö docs: update documentation to match code changes

          Only commit files that you actually modified. If no documentation drift was found,
          DO NOT create an empty commit.

          ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
          STEP 6 ‚Äî LEAVE A SUMMARY COMMENT
          ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
          Use the GitHub MCP Server to add a SHORT comment on the PR:

          - If you made changes:
            > üìö **Documentation updated!**
            >
            > I detected documentation drift and pushed a commit to fix it:
            > - (list each file changed and a one-line summary of what was updated)
            >
            > Please review the changes and adjust if needed.
            >
            > ---
            > ü§ñ *Auto-updated by Copilot Continuous Documentation*

          - If everything was already in sync:
            > üìö **Docs are in sync!** No documentation drift detected for this PR. Great job! üëè

          IMPORTANT GUIDELINES:
          - NEVER change the meaning or intent of existing documentation ‚Äî only fix drift
          - Respect the project's existing documentation style, language, and formatting
          - If the project has docs in multiple languages (e.g. README.md and README.es.md), update ALL of them
          - Only fix documentation issues directly caused by THIS PR's changes
          - Don't rewrite well-written docs ‚Äî make minimal, targeted fixes
          - If the PR already includes correct documentation updates, just confirm they look good
          - Be conservative ‚Äî when in doubt, skip a marginal change rather than risk breaking good docs
          PROMPT_EOF
          )

          copilot -p "Repository: ${REPO_NAME}. PR number: #${PR_NUMBER}. Head branch: ${HEAD_REF}. ${PROMPT}" \
            --allow-all-tools --model "$MODEL"
          exit_code=$?

          if [ $exit_code -ne 0 ]; then
            echo "::error::Copilot CLI failed with exit code $exit_code for PR #$PR_NUMBER"
            exit $exit_code
          fi

          echo "‚úÖ Documentation analysis completed for PR #$PR_NUMBER"
