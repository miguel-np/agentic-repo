name: üìö Continuous Documentation

on:
  pull_request:
    types: [opened, synchronize]
    paths:
      - "**/*.js"
      - "**/*.ts"
      - "**/*.py"
      - "**/*.go"
      - "**/*.java"
      - "**/*.cs"
      - "**/*.rb"
      - "**/*.rs"
      - "**/*.php"
      - "**/*.swift"
      - "**/*.kt"
      - "**/*.sh"
      - "**/*.yml"
      - "**/*.yaml"
      - "**/*.json"
  workflow_call:
    inputs:
      pr_number:
        description: 'Pull request number'
        required: true
        type: string
      pr_title:
        description: 'Pull request title'
        required: true
        type: string
      pr_author:
        description: 'Pull request author login'
        required: true
        type: string
      base_ref:
        description: 'Base branch of the PR'
        required: true
        type: string
      head_ref:
        description: 'Head branch of the PR'
        required: true
        type: string
      author_filter:
        description: 'Who can trigger this workflow: owner_only, collaborators, or all'
        required: false
        type: string
        default: 'owner_only'
    secrets:
      COPILOT_PAT:
        required: true

permissions:
  contents: write
  pull-requests: write

jobs:
  continuous-docs:
    name: üìö Check & Improve Documentation
    runs-on: ubuntu-latest

    steps:
      - name: üîê Verify author is allowed
        id: author_check
        env:
          REPO_OWNER: ${{ github.repository_owner }}
          REPO_FULL: ${{ github.repository }}
          INPUT_AUTHOR: ${{ inputs.pr_author || github.event.pull_request.user.login }}
          AUTHOR_FILTER: ${{ inputs.author_filter || 'owner_only' }}
          GH_TOKEN: ${{ secrets.COPILOT_PAT || github.token }}
        run: |
          allowed="false"
          case "$AUTHOR_FILTER" in
            all)
              allowed="true"
              ;;
            collaborators)
              perm=$(gh api "repos/${REPO_FULL}/collaborators/${INPUT_AUTHOR}/permission" --jq '.permission' 2>/dev/null || echo "none")
              if [ "$perm" = "admin" ] || [ "$perm" = "write" ] || [ "$perm" = "maintain" ]; then
                allowed="true"
              fi
              ;;
            owner_only|*)
              if [ "$INPUT_AUTHOR" = "$REPO_OWNER" ]; then
                allowed="true"
              fi
              ;;
          esac

          echo "allowed=$allowed" >> "$GITHUB_OUTPUT"
          if [ "$allowed" != "true" ]; then
            echo "Skipping: author '$INPUT_AUTHOR' not allowed under filter '$AUTHOR_FILTER'."
          fi

      - name: üì• Checkout PR branch
        if: ${{ steps.author_check.outputs.allowed == 'true' }}
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ inputs.head_ref || github.event.pull_request.head.ref }}
          token: ${{ secrets.COPILOT_PAT || github.token }}

      - name: üì¶ Install GitHub Copilot CLI
        if: ${{ steps.author_check.outputs.allowed == 'true' }}
        run: |
          curl -fsSL https://gh.io/copilot-install | bash
          echo "$HOME/.local/bin" >> $GITHUB_PATH
          echo "--- Copilot CLI version ---"
          $HOME/.local/bin/copilot --version 2>/dev/null || echo "(version flag not supported)"

      - name: üìö Analyze code changes and documentation drift
        if: ${{ steps.author_check.outputs.allowed == 'true' }}
        env:
          GH_TOKEN: ${{ secrets.COPILOT_PAT }}
          PR_NUMBER: ${{ inputs.pr_number || github.event.pull_request.number }}
          PR_TITLE: ${{ inputs.pr_title || github.event.pull_request.title }}
          PR_AUTHOR: ${{ inputs.pr_author || github.event.pull_request.user.login }}
          BASE_REF: ${{ inputs.base_ref || github.event.pull_request.base.ref }}
          HEAD_REF: ${{ inputs.head_ref || github.event.pull_request.head.ref }}
        run: |
          export PATH="$HOME/.local/bin:$PATH"

          copilot -p "
          You are an expert Continuous Documentation assistant for the repository '${{ github.repository }}'.
          Your job is to analyze code changes in a pull request, detect documentation drift,
          suggest README and API doc improvements, and nudge the PR author when explanations
          no longer match the actual implementation.

          PULL REQUEST DETAILS:
          - Number: #$PR_NUMBER
          - Title: $PR_TITLE
          - Author: @$PR_AUTHOR
          - Base branch: $BASE_REF
          - Head branch: $HEAD_REF

          Follow these steps IN ORDER:

          ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
          STEP 1 ‚Äî UNDERSTAND THE PROJECT
          ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
          - Read the repository README (and any localized versions like README.es.md) to understand
            what this project is about and what it documents.
          - Read AGENTS.md or CONTRIBUTING.md if they exist.
          - Scan the project structure to identify where documentation lives:
            README files, docs/ folder, API docs, JSDoc/docstrings, inline comments, etc.

          ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
          STEP 2 ‚Äî ANALYZE THE PR CHANGES
          ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
          - Use the GitHub MCP Server to get the full diff of PR #$PR_NUMBER.
          - Identify ALL files changed, added, or deleted.
          - Categorize the changes:
            a) New features or public APIs added
            b) Existing features or APIs modified (signature changes, behavior changes)
            c) Features or APIs removed/deprecated
            d) Configuration changes (env vars, settings, dependencies)
            e) Workflow or CI/CD changes
            f) Structural changes (files renamed, moved, or reorganized)

          ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
          STEP 3 ‚Äî DETECT DOCUMENTATION DRIFT
          ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
          For each change identified in Step 2, check whether existing documentation
          still accurately describes the code. Look for:

          a) **README drift**:
             - Does the README mention features, commands, APIs, or file paths that have changed?
             - Does the project structure section match the actual file tree?
             - Are installation or usage instructions still correct?
             - Are config examples or environment variable lists still accurate?

          b) **API / docstring drift**:
             - Have function signatures changed without updating their docstrings/JSDoc/type hints?
             - Have parameters been added, removed, or renamed without updating documentation?
             - Have return types or error behaviors changed?

          c) **Inline comment drift**:
             - Are there comments that describe logic which no longer matches the code below them?
             - Are TODO/FIXME/HACK comments that are now resolved but still present?

          d) **Config & dependency drift**:
             - Have new dependencies been added without documenting them in prerequisites?
             - Have environment variables changed without updating .env.example or the README?

          e) **Missing documentation for new code**:
             - New public functions/classes/endpoints without any documentation
             - New workflows or scripts without usage instructions
             - New config options without explanation

          ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
          STEP 4 ‚Äî FIX DOCUMENTATION DIRECTLY
          ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
          For each drift or gap found, EDIT THE FILES DIRECTLY in the working directory:

          a) **README drift**: Edit README.md (and localized versions like README.es.md)
             to fix outdated sections ‚Äî project structure, feature lists, usage instructions,
             config examples, environment variable references, etc.

          b) **API / docstring drift**: Edit the source files to update docstrings, JSDoc,
             type hints, or inline comments so they match the new code behavior.

          c) **Stale comments**: Remove or update TODO/FIXME/HACK comments that are now resolved.

          d) **Config & dependency docs**: Update .env.example, prerequisites sections,
             or setup instructions to reflect new dependencies or config changes.

          e) **Missing documentation for new code**: Add docstrings, README sections,
             or usage instructions for newly added public APIs, workflows, or scripts.

          Prioritize edits by impact:
            üî¥ Critical ‚Äî documentation is actively misleading (wrong instructions, wrong API)
            üü° Important ‚Äî documentation is incomplete or stale but not harmful
            üü¢ Nice to have ‚Äî minor wording improvements, typo fixes, clarity enhancements

          Focus on üî¥ and üü° items. Only fix üü¢ items if there are few total changes.

          ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
          STEP 5 ‚Äî COMMIT AND PUSH CHANGES
          ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
          After editing the files, use the GitHub MCP Server to push the changes
          to the HEAD branch of the PR ($HEAD_REF) with a commit message like:

            üìö docs: update documentation to match code changes

          Only commit files that you actually modified. If no documentation drift was found,
          DO NOT create an empty commit.

          ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
          STEP 6 ‚Äî LEAVE A SUMMARY COMMENT
          ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
          Use the GitHub MCP Server to add a SHORT comment on PR #$PR_NUMBER:

          - If you made changes:
            > üìö **Documentation updated!**
            >
            > I detected documentation drift and pushed a commit to fix it:
            > - (list each file changed and a one-line summary of what was updated)
            >
            > Please review the changes and adjust if needed.
            >
            > ---
            > ü§ñ *Auto-updated by Copilot Continuous Documentation*

          - If everything was already in sync:
            > üìö **Docs are in sync!** No documentation drift detected for this PR. Great job @$PR_AUTHOR! üëè

          IMPORTANT GUIDELINES:
          - NEVER change the meaning or intent of existing documentation ‚Äî only fix drift
          - Respect the project's existing documentation style, language, and formatting
          - If the project has docs in multiple languages (e.g. README.md and README.es.md), update ALL of them
          - Only fix documentation issues directly caused by THIS PR's changes
          - Don't rewrite well-written docs ‚Äî make minimal, targeted fixes
          - If the PR already includes correct documentation updates, just confirm they look good
          - Be conservative ‚Äî when in doubt, skip a marginal change rather than risk breaking good docs
          " --allow-all-tools --model claude-opus-4.6
          exit_code=$?

          if [ $exit_code -ne 0 ]; then
            echo "::error::Copilot CLI failed with exit code $exit_code for PR #$PR_NUMBER"
            exit $exit_code
          fi

          echo "‚úÖ Documentation analysis completed for PR #$PR_NUMBER"
