name: "\u270D\uFE0F Issue Quality Enhancer"

on:
  issues:
    types: [opened]
  workflow_call:
    inputs:
      issue_number:
        description: 'Issue number to enhance'
        required: true
        type: string
      issue_title:
        description: 'Issue title'
        required: true
        type: string
      issue_body:
        description: 'Issue body'
        required: false
        type: string
        default: ''
      issue_author:
        description: 'Issue author login'
        required: true
        type: string
      author_filter:
        description: 'Who can trigger this workflow: owner_only, collaborators, or all'
        required: false
        type: string
        default: 'owner_only'
      model:
        description: 'Copilot model to use'
        required: false
        type: string
        default: 'claude-sonnet-4'
    secrets:
      COPILOT_PAT:
        required: true

permissions:
  contents: read
  issues: write

jobs:
  enhance-issue:
    name: "\u270D\uFE0F Enhance Issue Quality"
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: "\uD83D\uDD10 Verify author is allowed"
        id: author_check
        uses: ./.github/actions/check-author
        with:
          author: ${{ inputs.issue_author || github.event.issue.user.login }}
          author_filter: ${{ inputs.author_filter || 'owner_only' }}
          repo_owner: ${{ github.repository_owner }}
          repo_full: ${{ github.repository }}
          token: ${{ secrets.COPILOT_PAT || github.token }}

      - name: "\uD83D\uDCE5 Checkout repository"
        if: steps.author_check.outputs.allowed == 'true'
        uses: actions/checkout@v4

      - name: "\uD83D\uDCE6 Install GitHub Copilot CLI"
        if: steps.author_check.outputs.allowed == 'true'
        uses: ./.github/actions/install-copilot

      - name: "\u270D\uFE0F Enhance issue title and body"
        if: steps.author_check.outputs.allowed == 'true'
        env:
          GH_TOKEN: ${{ secrets.COPILOT_PAT }}
          ISSUE_NUMBER: ${{ inputs.issue_number || github.event.issue.number }}
          REPO_NAME: ${{ github.repository }}
          MODEL: ${{ inputs.model || 'claude-sonnet-4' }}
        run: |
          export PATH="$HOME/.local/bin:$PATH"

          PROMPT=$(cat <<'PROMPT_EOF'
          You are an expert Issue Quality Enhancer for the repository.
          Your job is to take a newly opened issue and improve its quality so it is clear, detailed,
          well-structured, and consistent with the project standards.

          Use the GitHub MCP Server to read the full issue details by number â€” do NOT rely
          on any pre-filled title or body text. Fetch the issue fresh from the API.

          Follow these steps IN ORDER:

          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          STEP 1 â€” UNDERSTAND THE PROJECT CONTEXT
          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          - Read the repository README to understand what this project is about.
          - Read the AGENTS.md file for additional context about best practices.
          - Scan the source code structure to know what modules, files and technologies exist.
          - Use the GitHub MCP Server to list the last 10 closed and open issues in this repository
            so you can learn the naming conventions, language and structure used.

          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          STEP 2 â€” UNDERSTAND THE LABELS
          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          - Use the GitHub MCP Server to list ALL available labels in this repository.
          - Save this list â€” you will need it later to assign labels.

          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          STEP 3 â€” DETECT LANGUAGE & TRANSLATE
          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          - Detect the language of the original title and body.
          - This project uses ENGLISH for all issues.
          - If the title or body are in ANY language other than English (e.g., Spanish, French, etc.),
            translate the content to clear, professional English.
          - Preserve the original meaning and technical details during translation.

          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          STEP 4 â€” ENHANCE THE TITLE
          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          Create a new, improved title following these rules:
          - Start with a relevant emoji that represents the issue type. Common examples:
            ðŸ› bug, âœ¨ feature/enhancement, ðŸ“ documentation, ðŸŽ¨ design/visual,
            ðŸ”§ refactoring, ðŸ”’ security, âš¡ performance, ðŸ§ª testing, ðŸ—ï¸ architecture,
            â™»ï¸ tech debt, ðŸš€ deployment/CI, â¬†ï¸ dependencies
            Choose other emojis when they better represent the project's domain.
          - Keep it concise but descriptive (5-12 words after the emoji)
          - Use imperative mood (e.g., 'Add dark mode support' not 'Adding dark mode support')
          - Do NOT include issue type prefixes like '[BUG]' or '[FEATURE]' â€” the emoji replaces those

          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          STEP 5 â€” ENHANCE THE BODY
          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          Rewrite the issue body using this structure. Adapt sections based on issue type:

          **For Bug Reports:**
          ```
          ## ðŸ› Description
          Clear description of what's broken.

          ## ðŸ“‹ Steps to Reproduce
          1. Step one
          2. Step two
          3. ...

          ## âœ… Expected Behavior
          What should happen.

          ## âŒ Actual Behavior
          What happens instead.

          ## ðŸ–¥ï¸ Environment (if applicable)
          - OS:
          - Python version:
          - Dependencies:

          ## ðŸ“¸ Screenshots / Logs (if applicable)
          Any relevant output.
          ```

          **For Feature Requests / Enhancements:**
          ```
          ## âœ¨ Description
          Clear description of the proposed feature or improvement.

          ## ðŸŽ¯ Motivation
          Why is this needed? What problem does it solve?

          ## ðŸ“ Proposed Solution
          How should this be implemented? Include technical details if possible.

          ## ðŸ”„ Alternatives Considered (if any)
          Other approaches that were considered.

          ## ðŸ“Ž Additional Context
          Links, references, or screenshots.
          ```

          **For other issue types use a sensible structure with emoji section headers.**

          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          STEP 6 â€” ANALYZE CODE FOR REFERENCES
          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          - Based on the issue topic, search the repository code for relevant files, functions,
            classes, or configuration that relate to the issue.
          - If you find relevant code references, add a section at the end of the body:

            ## ðŸ” Relevant Code References
            - `path/to/file.py` â€” Brief description of why this file is relevant
            - `path/to/another.py:L42` â€” Specific function or line related to this issue

          - If the issue mentions a technology or library, check if it's already used in the project
            and note the current version or usage.
          - Add links to official documentation if they help clarify the issue:

            ## ðŸ“š Useful Documentation
            - [Library Name â€” Topic](https://docs.example.com/relevant-page)

          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          STEP 7 â€” ADD CREDIT FOOTER
          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          At the very end of the body, add:

          ---
          > âœï¸ *This issue was automatically enhanced by Copilot CLI. Original author: @ISSUE_AUTHOR*

          (Replace ISSUE_AUTHOR with the actual author login fetched from the API.)

          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          STEP 8 â€” UPDATE THE ISSUE
          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          Use the GitHub MCP Server to UPDATE the issue with:
          - The new enhanced title
          - The new enhanced body
          DO NOT create a new issue. UPDATE the existing one.

          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          STEP 9 â€” ASSIGN LABELS
          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          - From the label list you fetched in Step 2, pick 1-3 labels that best match this issue.
          - Use the GitHub MCP Server to assign those labels to the issue.
          - Every issue MUST have at least one label.

          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          STEP 10 â€” ADD A FRIENDLY COMMENT
          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          Use the GitHub MCP Server to add a comment on the issue with a brief,
          friendly summary of what was improved. Example:

          > ðŸ¤– **Issue enhanced!** I've improved this issue by:
          > - Translated from Spanish to English
          > - Added a descriptive emoji title
          > - Structured the body with clear sections
          > - Added relevant code references
          >
          > Feel free to edit if anything needs adjusting!

          IMPORTANT GUIDELINES:
          - NEVER change the meaning or intent of the original issue
          - ALWAYS preserve all technical details from the original
          - If the original issue is already well-written in English with good structure, make only minimal improvements
          - Be helpful, not intrusive â€” enhance clarity without adding fluff
          - If the issue body is empty, infer what you can from the title and code analysis, but mark inferred sections clearly
          PROMPT_EOF
          )

          copilot -p "Repository: ${REPO_NAME}. Issue number: #${ISSUE_NUMBER}. ${PROMPT}" \
            --allow-all-tools --model "$MODEL"
          exit_code=$?

          if [ $exit_code -ne 0 ]; then
            echo "::error::Copilot CLI failed with exit code $exit_code for issue #$ISSUE_NUMBER"
            exit $exit_code
          fi

          echo "âœ… Issue #$ISSUE_NUMBER enhanced successfully"
