name: ðŸ“¦ Dependency Update Advisor

on:
  schedule:
    - cron: "0 10 * * 1" # Monday 10:00 UTC
  workflow_dispatch:
    inputs:
      severity_filter:
        description: 'Minimum severity to report'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - critical-only
          - security-only
  workflow_call:
    inputs:
      severity_filter:
        description: 'Minimum severity to report'
        required: false
        type: string
        default: 'all'
    secrets:
      COPILOT_PAT:
        required: true

permissions:
  contents: read
  issues: write

jobs:
  check-dependencies:
    name: ðŸ“¦ Check Dependency Updates
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ðŸ“¦ Install GitHub Copilot CLI
        run: |
          curl -fsSL https://gh.io/copilot-install | bash
          echo "$HOME/.local/bin" >> $GITHUB_PATH
          echo "--- Copilot CLI version ---"
          $HOME/.local/bin/copilot --version 2>/dev/null || echo "(version flag not supported)"

      - name: ðŸ“¦ Analyze dependencies and create advisory
        env:
          GH_TOKEN: ${{ secrets.COPILOT_PAT }}
          SEVERITY_FILTER: ${{ inputs.severity_filter || 'all' }}
        run: |
          export PATH="$HOME/.local/bin:$PATH"

          copilot -p "
          You are a Dependency Update Advisor for the repository '${{ github.repository }}'.
          Your job is to analyze the project dependencies, check for available updates
          and known vulnerabilities, and create a well-structured issue summarizing the findings.

          CONFIGURATION:
          - Severity filter: $SEVERITY_FILTER
            - 'all': report all updates (major, minor, patch)
            - 'critical-only': only report major version updates and security vulnerabilities
            - 'security-only': only report known security vulnerabilities

          Follow these steps IN ORDER:

          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          STEP 1 â€” DETECT PROJECT TYPE AND DEPENDENCIES
          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          - Scan the repository for dependency files:
            - package.json / package-lock.json (Node.js/npm)
            - composer.json / composer.lock (PHP/Composer)
            - requirements.txt / Pipfile / pyproject.toml (Python)
            - Gemfile / Gemfile.lock (Ruby)
            - go.mod / go.sum (Go)
            - Cargo.toml / Cargo.lock (Rust)
            - pom.xml / build.gradle (Java)
            - *.csproj / packages.config (.NET)
          - List all direct dependencies and their current versions.
          - If no dependency file is found, report that and stop.

          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          STEP 2 â€” CHECK FOR EXISTING ADVISORY ISSUE
          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          - Use the GitHub MCP Server to search for open issues with the label 'ðŸ“¦ dependencies'
            or titled 'Dependency Update Advisory'.
          - If a recent advisory issue exists (created in the last 7 days), STOP and add a
            comment to it instead of creating a new one.

          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          STEP 3 â€” ANALYZE UPDATES AVAILABLE
          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          For each dependency:
          - Determine the latest stable version available.
          - Classify the update:
            - ðŸ”´ **Major** â€” breaking changes likely (e.g., 2.x â†’ 3.x)
            - ðŸŸ¡ **Minor** â€” new features, backward compatible (e.g., 2.1 â†’ 2.2)
            - ðŸŸ¢ **Patch** â€” bug fixes only (e.g., 2.1.0 â†’ 2.1.1)
          - Check if the dependency has any known security advisories (CVEs).
          - Note any deprecation notices.

          Apply the severity filter:
          - If '$SEVERITY_FILTER' is 'critical-only': only include Major updates and security issues.
          - If '$SEVERITY_FILTER' is 'security-only': only include dependencies with known CVEs.
          - If '$SEVERITY_FILTER' is 'all': include everything.

          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          STEP 4 â€” CREATE ADVISORY ISSUE
          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          Use the GitHub MCP Server to create an issue with:

          **Title:** ðŸ“¦ Dependency Update Advisory â€” [DATE]

          **Body:**

          ## ðŸ“¦ Dependency Update Advisory

          Weekly automated check of project dependencies for available updates and security vulnerabilities.

          ### ðŸ”’ Security Vulnerabilities
          | Package | Current | Fixed In | CVE | Severity |
          |---------|---------|----------|-----|----------|
          ...
          (If none: 'âœ… No known security vulnerabilities found.')

          ### ðŸ”´ Major Updates (Breaking Changes)
          | Package | Current | Latest | Changelog |
          |---------|---------|--------|-----------|
          ...

          ### ðŸŸ¡ Minor Updates
          | Package | Current | Latest |
          |---------|---------|--------|
          ...

          ### ðŸŸ¢ Patch Updates
          | Package | Current | Latest |
          |---------|---------|--------|
          ...

          ### ðŸ“‹ Recommendations
          1. (Priority-ordered list of recommended actions)
          2. ...

          ---
          > ðŸ¤– *This advisory was automatically generated by Copilot CLI.*
          > *Review each update before applying. Run tests after updating.*

          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          STEP 5 â€” ASSIGN LABELS
          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          - List available labels in the repository.
          - If 'ðŸ“¦ dependencies' label exists, add it to the issue.
          - If any security vulnerabilities were found, also add 'ðŸ”’ security' if it exists.
          - Create the 'ðŸ“¦ dependencies' label if it doesn't exist (color: '0366d6',
            description: 'Dependency updates and advisories').

          IMPORTANT GUIDELINES:
          - Be accurate â€” verify version numbers from the actual dependency files
          - Don't create noise â€” if everything is up to date, create a brief issue confirming it
          - For security issues, always recommend the fix version explicitly
          - Include links to changelogs when available for major updates
          - Group related dependencies together (e.g., all @angular/* packages)
          " --allow-all-tools --model claude-opus-4.6
          exit_code=$?

          if [ $exit_code -ne 0 ]; then
            echo "::error::Copilot CLI failed with exit code $exit_code"
            exit $exit_code
          fi

          echo "âœ… Dependency analysis completed"
