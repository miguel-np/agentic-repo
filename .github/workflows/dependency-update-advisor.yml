name: ðŸ“¦ Dependency Update Advisor

on:
  schedule:
    - cron: "0 10 * * 1" # Monday 10:00 UTC
  workflow_dispatch:
    inputs:
      severity_filter:
        description: 'Minimum severity to report'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - critical-only
          - security-only
  workflow_call:
    inputs:
      severity_filter:
        description: 'Minimum severity to report'
        required: false
        type: string
        default: 'all'
      model:
        description: 'Copilot model to use'
        required: false
        type: string
        default: 'claude-sonnet-4'
    secrets:
      COPILOT_PAT:
        required: true

permissions:
  contents: read
  issues: write

jobs:
  check-dependencies:
    name: ðŸ“¦ Check Dependency Updates
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ðŸ“¦ Install GitHub Copilot CLI
        uses: ./.github/actions/install-copilot

      - name: ðŸ“¦ Analyze dependencies and create advisory
        env:
          GH_TOKEN: ${{ secrets.COPILOT_PAT }}
          SEVERITY_FILTER: ${{ inputs.severity_filter || 'all' }}
          REPO_NAME: ${{ github.repository }}
          MODEL: ${{ inputs.model || 'claude-sonnet-4' }}
        run: |
          export PATH="$HOME/.local/bin:$PATH"

          PROMPT=$(cat <<'PROMPT_EOF'
          You are a Dependency Update Advisor for the repository.
          Your job is to analyze the project dependencies, check for available updates
          and known vulnerabilities, and create a well-structured issue summarizing the findings.

          Follow these steps IN ORDER:

          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          STEP 1 â€” DETECT PROJECT TYPE AND DEPENDENCIES
          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          - Scan for dependency files: package.json, composer.json, requirements.txt, Pipfile,
            pyproject.toml, Gemfile, go.mod, Cargo.toml, pom.xml, build.gradle, *.csproj.
          - List all direct dependencies and their current versions.
          - If no dependency file is found, report that and stop.

          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          STEP 2 â€” CHECK FOR EXISTING ADVISORY ISSUE
          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          - Search for open issues with label 'ðŸ“¦ dependencies' or titled 'Dependency Update Advisory'.
          - If a recent advisory exists (last 7 days), add a comment to it instead.

          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          STEP 3 â€” ANALYZE UPDATES AVAILABLE
          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          For each dependency: determine latest stable version, classify update type
          (ðŸ”´ Major, ðŸŸ¡ Minor, ðŸŸ¢ Patch), check for known CVEs and deprecation notices.
          Apply the severity filter.

          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          STEP 4 â€” CREATE ADVISORY ISSUE
          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          Create an issue with structured sections: Security Vulnerabilities, Major Updates,
          Minor Updates, Patch Updates, and Recommendations.

          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          STEP 5 â€” ASSIGN LABELS
          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          Add 'ðŸ“¦ dependencies' label (create if needed). If security issues found, add 'ðŸ”’ security'.

          IMPORTANT GUIDELINES:
          - Be accurate â€” verify version numbers from actual dependency files
          - Don't create noise â€” if everything is up to date, create a brief confirming issue
          - For security issues, always recommend the fix version explicitly
          - Include changelog links for major updates when available
          PROMPT_EOF
          )

          copilot -p "Repository: ${REPO_NAME}. Severity filter: ${SEVERITY_FILTER}. ${PROMPT}" \
            --allow-all-tools --model "$MODEL"
          exit_code=$?

          if [ $exit_code -ne 0 ]; then
            echo "::error::Copilot CLI failed with exit code $exit_code"
            exit $exit_code
          fi

          echo "âœ… Dependency analysis completed"
