name: ðŸ§¹ Stale Issue & PR Manager

on:
  schedule:
    - cron: "0 9 * * 1" # Monday 9:00 UTC
  workflow_dispatch:
    inputs:
      stale_days:
        description: 'Days of inactivity before marking as stale'
        required: false
        default: '30'
        type: string
      close_days:
        description: 'Days after stale warning before closing'
        required: false
        default: '14'
        type: string
      dry_run:
        description: 'Preview changes without applying them'
        required: false
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'
  workflow_call:
    inputs:
      stale_days:
        description: 'Days of inactivity before marking as stale'
        required: false
        type: string
        default: '30'
      close_days:
        description: 'Days after stale warning before closing'
        required: false
        type: string
        default: '14'
      dry_run:
        description: 'Preview changes without applying them'
        required: false
        type: string
        default: 'true'
      model:
        description: 'Copilot model to use'
        required: false
        type: string
        default: 'claude-sonnet-4.6'
    secrets:
      COPILOT_PAT:
        required: true

permissions:
  contents: read
  issues: write
  pull-requests: write

concurrency:
  group: stale-manager
  cancel-in-progress: true

jobs:
  manage-stale:
    name: ðŸ§¹ Manage Stale Items
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ðŸ“¦ Install GitHub Copilot CLI
        uses: ./.github/actions/install-copilot

      - name: ðŸ§¹ Analyze and manage stale items
        env:
          GH_TOKEN: ${{ secrets.COPILOT_PAT }}
          STALE_DAYS: ${{ inputs.stale_days || '30' }}
          CLOSE_DAYS: ${{ inputs.close_days || '14' }}
          DRY_RUN: ${{ inputs.dry_run || 'true' }}
          REPO_NAME: ${{ github.repository }}
          MODEL: ${{ inputs.model || 'claude-sonnet-4.6' }}
        run: |
          export PATH="$HOME/.local/bin:$PATH"

          PROMPT=$(cat <<'PROMPT_EOF'
          You are a Stale Issue & PR Manager for the repository.
          Your job is to identify issues and PRs that have been inactive for too long,
          warn their authors, and close truly abandoned items.

          Follow these steps IN ORDER:

          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          STEP 1 â€” ENSURE THE STALE LABEL EXISTS
          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          - List all labels. If 'ðŸ§¹ stale' does NOT exist, create it
            (color: '795548', description: 'Issue or PR with no recent activity').
          - If DRY RUN MODE is enabled, skip the creation but note it would be created.

          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          STEP 2 â€” FIND STALE ISSUES
          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          - List all OPEN issues. For each, check the last activity date.
          - An issue is STALE if: inactive for the configured days, NOT labeled 'in-progress'/'wip'/'blocked', NOT pinned.
          - Separate into: NEWLY STALE (needs warning) and READY TO CLOSE (warning expired).

          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          STEP 3 â€” FIND STALE PULL REQUESTS
          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          - Apply the same logic for PRs. Also skip PRs with pending review requests.

          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          STEP 4 â€” GENERATE THE ACTION PLAN
          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          Display summary tables for: newly stale, ready to close, and excluded items.
          If DRY RUN MODE is enabled: STOP HERE.

          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          STEP 5 â€” WARN NEWLY STALE ITEMS
          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          Only if DRY RUN is disabled: add the 'ðŸ§¹ stale' label and post a friendly warning comment.

          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          STEP 6 â€” CLOSE EXPIRED STALE ITEMS
          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          Only if DRY RUN is disabled: post a closing comment and close the item.

          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          STEP 7 â€” POST SUMMARY
          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          Print final summary: total checked, warned, closed, excluded, still waiting.

          IMPORTANT GUIDELINES:
          - NEVER close items with recent activity â€” double-check dates
          - NEVER close items labeled 'in-progress', 'wip', 'blocked', or 'pinned'
          - NEVER close items with active discussions
          - Be friendly and respectful in all comments
          - When in doubt, warn but don't close
          PROMPT_EOF
          )

          copilot -p "Repository: ${REPO_NAME}. Stale threshold: ${STALE_DAYS} days. Close threshold: ${CLOSE_DAYS} days after warning. DRY RUN: ${DRY_RUN}. ${PROMPT}" \
            --allow-all-tools --model "$MODEL"
          exit_code=$?

          if [ $exit_code -ne 0 ]; then
            echo "::error::Copilot CLI failed with exit code $exit_code"
            exit $exit_code
          fi

          echo "âœ… Stale management completed"
