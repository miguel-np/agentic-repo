name: ðŸ§¹ Stale Issue & PR Manager

on:
  schedule:
    - cron: "0 9 * * 1" # Monday 9:00 UTC
  workflow_dispatch:
    inputs:
      stale_days:
        description: 'Days of inactivity before marking as stale'
        required: false
        default: '30'
        type: string
      close_days:
        description: 'Days after stale warning before closing'
        required: false
        default: '14'
        type: string
      dry_run:
        description: 'Preview changes without applying them'
        required: false
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'
  workflow_call:
    inputs:
      stale_days:
        description: 'Days of inactivity before marking as stale'
        required: false
        type: string
        default: '30'
      close_days:
        description: 'Days after stale warning before closing'
        required: false
        type: string
        default: '14'
      dry_run:
        description: 'Preview changes without applying them'
        required: false
        type: string
        default: 'true'
    secrets:
      COPILOT_PAT:
        required: true

permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  manage-stale:
    name: ðŸ§¹ Manage Stale Items
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ðŸ“¦ Install GitHub Copilot CLI
        run: |
          curl -fsSL https://gh.io/copilot-install | bash
          echo "$HOME/.local/bin" >> $GITHUB_PATH
          echo "--- Copilot CLI version ---"
          $HOME/.local/bin/copilot --version 2>/dev/null || echo "(version flag not supported)"

      - name: ðŸ§¹ Analyze and manage stale items
        env:
          GH_TOKEN: ${{ secrets.COPILOT_PAT }}
          STALE_DAYS: ${{ inputs.stale_days || '30' }}
          CLOSE_DAYS: ${{ inputs.close_days || '14' }}
          DRY_RUN: ${{ inputs.dry_run || 'true' }}
        run: |
          export PATH="$HOME/.local/bin:$PATH"

          copilot -p "
          You are a Stale Issue & PR Manager for the repository '${{ github.repository }}'.
          Your job is to identify issues and PRs that have been inactive for too long,
          warn their authors, and close truly abandoned items.

          CONFIGURATION:
          - Stale threshold: $STALE_DAYS days of inactivity
          - Close threshold: $CLOSE_DAYS days after stale warning with no response
          - DRY RUN MODE: $DRY_RUN

          Follow these steps IN ORDER:

          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          STEP 1 â€” ENSURE THE STALE LABEL EXISTS
          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          - Use the GitHub MCP Server to list all labels in this repository.
          - If a label named 'ðŸ§¹ stale' does NOT exist, create it with:
            - Name: 'ðŸ§¹ stale'
            - Color: '795548'
            - Description: 'Issue or PR with no recent activity'
          - If DRY RUN MODE is 'true', skip the creation but note it would be created.

          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          STEP 2 â€” FIND STALE ISSUES
          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          - Use the GitHub MCP Server to list all OPEN issues in this repository.
          - For each issue, check the last activity date (last comment or last update).
          - An issue is considered STALE if:
            a) It has had no comments or updates for at least $STALE_DAYS days
            b) It does NOT have a label indicating active work (e.g., 'in-progress', 'wip', 'blocked')
            c) It is NOT pinned
          - Separate stale issues into two groups:
            a) NEWLY STALE: inactive for $STALE_DAYS+ days but NOT yet labeled 'ðŸ§¹ stale'
            b) READY TO CLOSE: already labeled 'ðŸ§¹ stale' AND inactive for $CLOSE_DAYS+ more days since the stale warning

          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          STEP 3 â€” FIND STALE PULL REQUESTS
          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          - Use the GitHub MCP Server to list all OPEN pull requests in this repository.
          - Apply the same logic as Step 2 for PRs.
          - Additionally, skip PRs that have pending review requests (they may be waiting on reviewers).
          - A PR is considered stale if no commits, comments, or reviews in $STALE_DAYS days.

          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          STEP 4 â€” GENERATE THE ACTION PLAN
          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          Display a summary table:

          ### Newly Stale (will receive warning)
          | Type | # | Title | Last Activity | Days Inactive |
          |------|---|-------|---------------|---------------|
          ...

          ### Ready to Close (warning expired with no response)
          | Type | # | Title | Stale Warning Date | Days Since Warning |
          |------|---|-------|--------------------|--------------------|
          ...

          ### Excluded (active, in-progress, or pinned)
          | Type | # | Title | Reason Excluded |
          |------|---|-------|-----------------|
          ...

          If DRY RUN MODE is 'true': STOP HERE. Do not modify any issues or PRs.

          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          STEP 5 â€” WARN NEWLY STALE ITEMS
          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          Only if DRY RUN MODE is 'false':

          For each NEWLY STALE item:
          1. Add the 'ðŸ§¹ stale' label
          2. Post a comment:

          > ðŸ‘‹ Hey @AUTHOR â€” this ITEM_TYPE has been inactive for DAYS days.
          >
          > Is this still relevant? Please respond with an update or we'll close it
          > automatically in $CLOSE_DAYS days to keep the backlog clean.
          >
          > - Comment to keep it open
          > - Close it yourself if it's no longer needed
          >
          > ---
          > ðŸ¤– *Automated stale check by Copilot CLI*

          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          STEP 6 â€” CLOSE EXPIRED STALE ITEMS
          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          Only if DRY RUN MODE is 'false':

          For each READY TO CLOSE item:
          1. Post a closing comment:

          > ðŸ”’ Closing this ITEM_TYPE due to inactivity. It was marked as stale DAYS
          > days ago with no further response.
          >
          > If this is still relevant, feel free to reopen it with an update.
          >
          > ---
          > ðŸ¤– *Automatically closed by Copilot CLI*

          2. Close the issue or PR.

          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          STEP 7 â€” POST SUMMARY
          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          Print a final summary:
          - Total open issues/PRs checked
          - Items warned as stale
          - Items closed
          - Items excluded
          - Items already stale (still waiting)

          IMPORTANT GUIDELINES:
          - NEVER close items with recent activity â€” double-check the dates
          - NEVER close items labeled as 'in-progress', 'wip', 'blocked', or 'pinned'
          - NEVER close items with active discussions (recent comments from multiple users)
          - Be friendly and respectful in all comments
          - The goal is to keep the backlog clean, NOT to be aggressive about closing things
          - When in doubt, warn but don't close
          " --allow-all-tools --model claude-opus-4.6
          exit_code=$?

          if [ $exit_code -ne 0 ]; then
            echo "::error::Copilot CLI failed with exit code $exit_code"
            exit $exit_code
          fi

          echo "âœ… Stale management completed"
