name: "\uD83C\uDFF7\uFE0F Smart Issue & PR Labeler"

on:
  issues:
    types: [opened, edited]
  pull_request:
    types: [opened, edited]
  workflow_call:
    inputs:
      item_type:
        description: 'Type of item (issue or pull_request)'
        required: true
        type: string
      item_author:
        description: 'Item author login'
        required: false
        type: string
      item_number:
        description: 'Item number'
        required: true
        type: string
      item_title:
        description: 'Item title'
        required: true
        type: string
      item_body:
        description: 'Item body'
        required: false
        type: string
        default: ''
      author_filter:
        description: 'Who can trigger this workflow: owner_only, collaborators, or all'
        required: false
        type: string
        default: 'owner_only'
      model:
        description: 'Copilot model to use'
        required: false
        type: string
        default: 'gpt-4.1-mini'
    secrets:
      COPILOT_PAT:
        required: true

permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  smart-label:
    name: "\uD83C\uDFF7\uFE0F Analyze and Label"
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: "\uD83D\uDD10 Verify author is allowed"
        id: author_check
        uses: ./.github/actions/check-author
        with:
          author: ${{ inputs.item_author || github.event.issue.user.login || github.event.pull_request.user.login }}
          author_filter: ${{ inputs.author_filter || 'owner_only' }}
          repo_owner: ${{ github.repository_owner }}
          repo_full: ${{ github.repository }}
          token: ${{ secrets.COPILOT_PAT || github.token }}

      - name: "\u23F3 Check if Issue Quality Enhancer already handled this"
        if: steps.author_check.outputs.allowed == 'true' && github.event_name == 'issues' && github.event.action == 'opened'
        id: enhancer_check
        env:
          GH_TOKEN: ${{ secrets.COPILOT_PAT || github.token }}
          REPO: ${{ github.repository }}
          ISSUE_NUMBER: ${{ inputs.item_number || github.event.issue.number }}
        run: |
          # Wait briefly to let the Issue Quality Enhancer start first
          sleep 15

          # Check if the enhancer already labelled this issue by looking for its comment
          comments=$(gh api "repos/${REPO}/issues/${ISSUE_NUMBER}/comments" --jq '.[].body' 2>/dev/null || echo "")
          if echo "$comments" | grep -q "Issue enhanced!"; then
            echo "skip=true" >> "$GITHUB_OUTPUT"
            echo "Issue Quality Enhancer already processed issue #${ISSUE_NUMBER}. Skipping smart labeling."
          else
            echo "skip=false" >> "$GITHUB_OUTPUT"
          fi

      - name: "\uD83D\uDCE5 Checkout repository"
        if: steps.author_check.outputs.allowed == 'true' && steps.enhancer_check.outputs.skip != 'true'
        uses: actions/checkout@v4

      - name: "\uD83D\uDCE6 Install GitHub Copilot CLI"
        if: steps.author_check.outputs.allowed == 'true' && steps.enhancer_check.outputs.skip != 'true'
        uses: ./.github/actions/install-copilot

      - name: "\uD83C\uDFF7\uFE0F Analyze and assign labels"
        if: steps.author_check.outputs.allowed == 'true' && steps.enhancer_check.outputs.skip != 'true'
        env:
          GH_TOKEN: ${{ secrets.COPILOT_PAT }}
          ITEM_TYPE: ${{ inputs.item_type || (github.event_name == 'issues' && 'issue' || 'pull_request') }}
          ITEM_NUMBER: ${{ inputs.item_number || github.event.issue.number || github.event.pull_request.number }}
          REPO_NAME: ${{ github.repository }}
          MODEL: ${{ inputs.model || 'gpt-4.1-mini' }}
        run: |
          export PATH="$HOME/.local/bin:$PATH"

          PROMPT=$(cat <<'PROMPT_EOF'
          You are a smart labeling assistant. Your task is to analyze a newly opened/edited item
          and ensure it has the correct labels.

          Use the GitHub MCP Server to read the item details by number — do NOT rely
          on any pre-filled title or body text. Fetch the item fresh from the API.

          Follow these steps:

          1. FIRST: Use the GitHub MCP Server to list ALL available labels in this repository.
             SAVE this list - you will ONLY use labels from this list.
             DO NOT create new labels unless absolutely necessary (step 6).

          2. SECOND: Use the GitHub MCP Server to get the current labels on the item.
             Note which labels are already assigned.

          3. THIRD: Check if this issue was created from a Discussion:
             - Look in the issue body for references to discussions (e.g., 'Created from discussion #X' or links to discussions)
             - If it was created from a discussion, use the GitHub MCP Server to get that discussion's details
             - Check what labels the original discussion has - these are VERY helpful hints for labeling this issue
             - Use the discussion labels as a starting point for this issue's labels

          4. FOURTH: Analyze the title and body to determine what this item is about:
             - Is it a bug report? → 'bug' label
             - Is it a feature request? → 'enhancement' label
             - Is it about documentation? → 'documentation' label
             - Is it about security? → 'security' label (if exists)
             - Is it about performance? → 'performance' label (if exists)
             - Is it about testing? → 'testing' label (if exists)
             - Is it about CI/CD or workflows? → 'ci' or 'github-actions' label (if exists)
             - Is it about dependencies? → 'dependencies' label (if exists)
             - Is it a question? → 'question' label
             - Is it a good first issue for newcomers? → 'good first issue' label
             - Is it about UI/UX? → 'design' or 'ux' label (if exists)
             - Is it about refactoring? → 'refactoring' label (if exists)

             For Pull Requests specifically:
             - Does it fix a bug? → 'bug' label
             - Does it add a feature? → 'enhancement' label
             - Is it a breaking change? → 'breaking-change' label (if exists)
             - Is it a minor fix? → 'minor' label (if exists)

          5. FIFTH: Compare the labels that SHOULD be on this item vs what's currently assigned:
             - If current labels are correct and complete → do nothing, report 'Labels are already correct'
             - If labels are missing → add the missing ones
             - If labels are wrong/irrelevant → remove them and add correct ones
             - Aim for 1-3 labels per item - don't over-label

          6. SIXTH: Use the GitHub MCP Server to update the labels on the item:
             - Add any missing labels that should be there
             - Remove any labels that don't make sense for this item
             - Keep labels that are correctly assigned

          7. SEVENTH (ONLY IF ABSOLUTELY NECESSARY): If there's a clear category that doesn't have a matching label:
             - First, check if there's a similar label that could work
             - Only create a new label if:
               a) No existing label fits at all
               b) This category will likely be used again in the future
               c) The label name is clear and follows existing naming conventions
             - Use appropriate colors (red for bugs, green for enhancements, blue for docs, etc.)
             - This should be RARE - prefer using existing labels

          IMPORTANT GUIDELINES:
          - PRIORITIZE existing labels - don't create new ones unless truly needed
          - Keep the label count reasonable (1-3 labels is ideal)
          - Remove incorrect labels - it's better to have fewer correct labels than many wrong ones
          - If the item is well-labeled already, just report that and do nothing
          - Be conservative - when in doubt, don't add a label

          Report a summary at the end:
          - Current labels (before your changes)
          - Labels added
          - Labels removed
          - Labels created (if any - this should be rare!)
          - Final labels on the item
          PROMPT_EOF
          )

          copilot -p "Repository: ${REPO_NAME}. ${ITEM_TYPE} number: #${ITEM_NUMBER}. ${PROMPT}" \
            --allow-all-tools --model "$MODEL"
          exit_code=$?

          if [ $exit_code -ne 0 ]; then
            echo "::error::Copilot CLI failed with exit code $exit_code for ${ITEM_TYPE} #${ITEM_NUMBER}"
            exit $exit_code
          fi

          echo "✅ Smart labeling completed for ${ITEM_TYPE} #${ITEM_NUMBER}"
