name: "üè∑Ô∏è Smart Issue & PR Labeler"

on:
  issues:
    types: [opened, edited]
  pull_request:
    types: [opened, edited]
  workflow_call:
    inputs:
      item_type:
        description: 'Type of item (issue or pull_request)'
        required: true
        type: string
      item_author:
        description: 'Item author login'
        required: false
        type: string
      item_number:
        description: 'Item number'
        required: true
        type: string
      author_filter:
        description: 'Who can trigger this workflow: owner_only, collaborators, or all'
        required: false
        type: string
        default: 'collaborators'
      model:
        description: 'Copilot model to use'
        required: false
        type: string
        default: 'gpt-4.1-mini'
    secrets:
      COPILOT_PAT:
        required: true

permissions:
  contents: read
  issues: write
  pull-requests: write
  discussions: read

# Prevent duplicate labeling runs for the same item when edited rapidly.
concurrency:
  group: ${{ github.repository }}-smart-labeler-${{ github.event.issue.number || github.event.pull_request.number || inputs.item_number }}
  cancel-in-progress: true

jobs:
  smart-label:
    name: "üè∑Ô∏è Analyze and Label"
    runs-on: ubuntu-latest
    timeout-minutes: 7

    steps:
      - name: "üîê Verify author is allowed"
        id: author_check
        uses: ./.github/actions/check-author
        with:
          author: ${{ inputs.item_author || github.event.issue.user.login || github.event.pull_request.user.login }}
          author_filter: ${{ inputs.author_filter || 'collaborators' }}
          repo_owner: ${{ github.repository_owner }}
          repo_full: ${{ github.repository }}
          token: ${{ secrets.COPILOT_PAT || github.token }}

      - name: "‚è≥ Check if Issue Quality Enhancer already handled this"
        if: steps.author_check.outputs.allowed == 'true' && github.event_name == 'issues' && (github.event.action == 'opened' || github.event.action == 'edited')
        id: enhancer_check
        env:
          GH_TOKEN: ${{ secrets.COPILOT_PAT || github.token }}
          REPO: ${{ github.repository }}
          ISSUE_NUMBER: ${{ inputs.item_number || github.event.issue.number }}
          EVENT_ACTION: ${{ github.event.action }}
        run: |
          # On 'edited' events the issue-quality-enhancer may have just pushed its edit,
          # so its comment is very likely already present ‚Äî check immediately with no delay.
          # On 'opened' events, poll for up to 30 seconds (2 attempts √ó 15s) because the
          # enhancer and the labeler start in parallel and the enhancer can take 30-60s.
          # If the enhancer hasn't finished by then, proceed ‚Äî smart-labeler's labels are
          # lightweight and the enhancer will overwrite them anyway.
          if [ "$EVENT_ACTION" = "edited" ]; then
            comments=$(gh api "repos/${REPO}/issues/${ISSUE_NUMBER}/comments" --jq '.[].body' 2>/dev/null || echo "")
            if echo "$comments" | grep -q "Issue enhanced!"; then
              echo "skip=true" >> "$GITHUB_OUTPUT"
              echo "Issue Quality Enhancer already processed issue #${ISSUE_NUMBER} (edit triggered by enhancer). Skipping smart labeling."
              exit 0
            fi
            echo "skip=false" >> "$GITHUB_OUTPUT"
            echo "Proceeding: edited event but no enhancer comment found on issue #${ISSUE_NUMBER}."
            exit 0
          fi

          # 'opened' path: poll actively
          MAX_ATTEMPTS=2
          SLEEP_SECONDS=15
          for i in $(seq 1 $MAX_ATTEMPTS); do
            comments=$(gh api "repos/${REPO}/issues/${ISSUE_NUMBER}/comments" --jq '.[].body' 2>/dev/null || echo "")
            if echo "$comments" | grep -q "Issue enhanced!"; then
              echo "skip=true" >> "$GITHUB_OUTPUT"
              echo "Issue Quality Enhancer already processed issue #${ISSUE_NUMBER} (detected on attempt ${i}). Skipping smart labeling."
              exit 0
            fi
            if [ "$i" -lt "$MAX_ATTEMPTS" ]; then
              echo "Attempt ${i}/${MAX_ATTEMPTS}: enhancer comment not yet found. Waiting ${SLEEP_SECONDS}s..."
              sleep $SLEEP_SECONDS
            fi
          done
          echo "skip=false" >> "$GITHUB_OUTPUT"
          echo "Issue Quality Enhancer did not process issue #${ISSUE_NUMBER} ‚Äî proceeding with smart labeling."

      - name: "üì• Checkout repository"
        if: steps.author_check.outputs.allowed == 'true' && steps.enhancer_check.outputs.skip != 'true'
        uses: actions/checkout@v4

      - name: "üì¶ Install GitHub Copilot CLI"
        if: steps.author_check.outputs.allowed == 'true' && steps.enhancer_check.outputs.skip != 'true'
        uses: ./.github/actions/install-copilot

      - name: "üè∑Ô∏è Analyze and assign labels"
        if: steps.author_check.outputs.allowed == 'true' && steps.enhancer_check.outputs.skip != 'true'
        env:
          GH_TOKEN: ${{ secrets.COPILOT_PAT }}
          ITEM_TYPE: ${{ inputs.item_type || (github.event_name == 'issues' && 'issue' || 'pull_request') }}
          ITEM_NUMBER: ${{ inputs.item_number || github.event.issue.number || github.event.pull_request.number }}
          REPO_NAME: ${{ github.repository }}
          MODEL: ${{ inputs.model || 'gpt-4.1-mini' }}
        run: |
          export PATH="$HOME/.local/bin:$PATH"

          PROMPT=$(cat <<'PROMPT_EOF'
          You are a smart labeling assistant. Your task is to analyze a newly opened/edited item
          and ensure it has the correct labels.

          Use the GitHub MCP Server to read the item details by number ‚Äî do NOT rely
          on any pre-filled title or body text. Fetch the item fresh from the API.

          Follow these steps:

          1. FIRST: Use the GitHub MCP Server to list ALL available labels in this repository.
             SAVE this list - you will ONLY use labels from this list.
             DO NOT create new labels unless absolutely necessary (step 6).

          2. SECOND: Use the GitHub MCP Server to get the current labels on the item.
             Note which labels are already assigned.

          3. THIRD: Check if this issue was created from a Discussion:
             - Look in the issue body for references to discussions (e.g., 'Created from discussion #X' or links to discussions)
             - If it was created from a discussion, use the GitHub MCP Server to get that discussion's details
             - Check what labels the original discussion has - these are VERY helpful hints for labeling this issue
             - Use the discussion labels as a starting point for this issue's labels

          4. FOURTH: Analyze the title and body to determine what this item is about:
             - Is it a bug report? ‚Üí 'bug' label
             - Is it a feature request? ‚Üí 'enhancement' label
             - Is it about documentation? ‚Üí 'documentation' label
             - Is it about security? ‚Üí 'security' label (if exists)
             - Is it about performance? ‚Üí 'performance' label (if exists)
             - Is it about testing? ‚Üí 'testing' label (if exists)
             - Is it about CI/CD or workflows? ‚Üí 'ci' or 'github-actions' label (if exists)
             - Is it about dependencies? ‚Üí 'dependencies' label (if exists)
             - Is it a question? ‚Üí 'question' label
             - Is it a good first issue for newcomers? ‚Üí 'good first issue' label
             - Is it about UI/UX? ‚Üí 'design' or 'ux' label (if exists)
             - Is it about refactoring? ‚Üí 'refactoring' label (if exists)

             For Pull Requests specifically:
             - Does it fix a bug? ‚Üí 'bug' label
             - Does it add a feature? ‚Üí 'enhancement' label
             - Is it a breaking change? ‚Üí 'breaking-change' label (if exists)
             - Is it a minor fix? ‚Üí 'minor' label (if exists)

          5. FIFTH: Compare the labels that SHOULD be on this item vs what's currently assigned:
             - If current labels are correct and complete ‚Üí do nothing, report 'Labels are already correct'
             - If labels are missing ‚Üí add the missing ones
             - If labels are wrong/irrelevant ‚Üí remove them and add correct ones
             - Aim for 1-3 labels per item - don't over-label

          6. SIXTH: Use the GitHub MCP Server to update the labels on the item:
             - Add any missing labels that should be there
             - Remove any labels that don't make sense for this item
             - Keep labels that are correctly assigned

          7. SEVENTH (ONLY IF ABSOLUTELY NECESSARY): If there's a clear category that doesn't have a matching label:
             - First, check if there's a similar label that could work
             - Only create a new label if:
               a) No existing label fits at all
               b) This category will likely be used again in the future
               c) The label name is clear and follows existing naming conventions
             - Use appropriate colors (red for bugs, green for enhancements, blue for docs, etc.)
             - This should be RARE - prefer using existing labels

          IMPORTANT GUIDELINES:
          - PRIORITIZE existing labels - don't create new ones unless truly needed
          - Keep the label count reasonable (1-3 labels is ideal)
          - Remove incorrect labels - it's better to have fewer correct labels than many wrong ones
          - If the item is well-labeled already, just report that and do nothing
          - Be conservative - when in doubt, don't add a label

          Report a summary at the end:
          - Current labels (before your changes)
          - Labels added
          - Labels removed
          - Labels created (if any - this should be rare!)
          - Final labels on the item
          PROMPT_EOF
          )

          # Retry wrapper: retry up to 2 times with exponential backoff on transient failures.
          # timeout prevents the CLI from hanging indefinitely.
          MAX_RETRIES=2
          RETRY_DELAY=10
          for attempt in $(seq 0 $MAX_RETRIES); do
            if [ "$attempt" -gt 0 ]; then
              echo "::warning::Copilot CLI attempt $attempt failed. Retrying in ${RETRY_DELAY}s..."
              sleep $RETRY_DELAY
              RETRY_DELAY=$((RETRY_DELAY * 2))
            fi
            timeout 300 copilot -p "Repository: ${REPO_NAME}. ${ITEM_TYPE} number: #${ITEM_NUMBER}. ${PROMPT}" \
              --allow-all-tools --model "$MODEL" && break
            exit_code=$?
            if [ "$attempt" -eq "$MAX_RETRIES" ]; then
              echo "::error::Copilot CLI failed after $((MAX_RETRIES + 1)) attempts (exit code $exit_code) for ${ITEM_TYPE} #${ITEM_NUMBER}"
              exit $exit_code
            fi
          done

          echo "‚úÖ Smart labeling completed for ${ITEM_TYPE} #${ITEM_NUMBER}"
