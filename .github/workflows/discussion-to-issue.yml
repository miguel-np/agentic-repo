name: ðŸ’¬ Discussion to Issue Converter

on:
  discussion:
    types: [labeled]
  workflow_dispatch:
    inputs:
      discussion_number:
        description: 'Discussion number to convert'
        required: true
        type: string
      label_trigger:
        description: 'Label that triggers conversion (must match the label added)'
        required: false
        type: string
        default: 'âœ… accepted'
  workflow_call:
    inputs:
      discussion_number:
        description: 'Discussion number to convert'
        required: true
        type: string
      label_trigger:
        description: 'Label that triggers conversion'
        required: false
        type: string
        default: 'âœ… accepted'
      model:
        description: 'Copilot model to use'
        required: false
        type: string
        default: 'claude-sonnet-4.6'
    secrets:
      COPILOT_PAT:
        required: true

permissions:
  contents: read
  issues: write
  discussions: write

jobs:
  convert-discussion:
    name: ðŸ’¬ Convert Discussion to Issue
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: ðŸ” Check trigger label
        id: label_check
        env:
          EVENT_NAME: ${{ github.event_name }}
          LABEL_NAME: ${{ github.event.label.name }}
          LABEL_TRIGGER: ${{ inputs.label_trigger || 'âœ… accepted' }}
          DISCUSSION_NUMBER: ${{ github.event.discussion.number }}
          INPUT_DISCUSSION: ${{ inputs.discussion_number }}
        run: |
          if [ "$EVENT_NAME" = "discussion" ]; then
            if [ "$LABEL_NAME" = "$LABEL_TRIGGER" ]; then
              echo "proceed=true" >> "$GITHUB_OUTPUT"
              echo "discussion_number=$DISCUSSION_NUMBER" >> "$GITHUB_OUTPUT"
            else
              echo "Skipping: label '$LABEL_NAME' does not match trigger '$LABEL_TRIGGER'."
              echo "proceed=false" >> "$GITHUB_OUTPUT"
            fi
          else
            echo "proceed=true" >> "$GITHUB_OUTPUT"
            echo "discussion_number=$INPUT_DISCUSSION" >> "$GITHUB_OUTPUT"
          fi

      - name: ðŸ“¥ Checkout repository
        if: steps.label_check.outputs.proceed == 'true'
        uses: actions/checkout@v4

      - name: ðŸ“¦ Install GitHub Copilot CLI
        if: steps.label_check.outputs.proceed == 'true'
        uses: ./.github/actions/install-copilot

      - name: ðŸ’¬ Convert discussion to issue
        if: steps.label_check.outputs.proceed == 'true'
        env:
          GH_TOKEN: ${{ secrets.COPILOT_PAT }}
          DISCUSSION_NUMBER: ${{ steps.label_check.outputs.discussion_number }}
          REPO_NAME: ${{ github.repository }}
          MODEL: ${{ inputs.model || 'claude-sonnet-4.6' }}
        run: |
          export PATH="$HOME/.local/bin:$PATH"

          PROMPT=$(cat <<'PROMPT_EOF'
          You are a Discussion-to-Issue Converter for the repository.
          Your job is to take a GitHub Discussion that has been accepted and create a
          well-structured issue from it, preserving all context and maintaining bidirectional links.

          Use the GitHub MCP Server to read the discussion details by number.

          Follow these steps IN ORDER:

          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          STEP 1 â€” READ THE DISCUSSION
          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          - Get the full details: title, body, author, labels, and all comments/replies.
          - Note the category and any consensus reached in the comments.

          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          STEP 2 â€” CHECK FOR EXISTING ISSUE
          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          - Search for existing issues that reference this discussion.
          - If a duplicate issue exists, STOP and comment on the discussion.

          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          STEP 3 â€” UNDERSTAND THE LABELS
          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          - List ALL available labels in the repository.

          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          STEP 4 â€” CREATE THE ISSUE
          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          Create an issue with:
          - Title based on the discussion title (add emoji, use imperative mood)
          - Body with: Description, Motivation, Proposed Solution, Context (linking back to discussion)
          - Credit footer linking to the original discussion and author

          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          STEP 5 â€” ASSIGN LABELS
          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          Transfer relevant labels from the discussion. Ensure 1-3 labels are assigned.

          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          STEP 6 â€” LINK BACK TO THE DISCUSSION
          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          Add a comment on the original discussion confirming the issue was created.

          IMPORTANT GUIDELINES:
          - NEVER lose information â€” synthesize, don't truncate
          - Preserve attribution â€” credit the original author and participants
          - The issue should be ACTIONABLE â€” not just a copy
          - If the discussion is vague, structure it into clear requirements
          PROMPT_EOF
          )

          copilot -p "Repository: ${REPO_NAME}. Discussion number: #${DISCUSSION_NUMBER}. ${PROMPT}" \
            --allow-all-tools --model "$MODEL"
          exit_code=$?

          if [ $exit_code -ne 0 ]; then
            echo "::error::Copilot CLI failed with exit code $exit_code for discussion #$DISCUSSION_NUMBER"
            exit $exit_code
          fi

          echo "âœ… Discussion #$DISCUSSION_NUMBER converted to issue"
