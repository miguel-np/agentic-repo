name: ðŸ¥ README Health Check

on:
  schedule:
    - cron: "0 10 1 * *" # First day of each month at 10:00 UTC
  workflow_dispatch:
    inputs:
      fix_mode:
        description: 'Automatically fix issues found'
        required: false
        default: 'report-only'
        type: choice
        options:
          - report-only
          - auto-fix
  workflow_call:
    inputs:
      fix_mode:
        description: 'report-only or auto-fix'
        required: false
        type: string
        default: 'report-only'
    secrets:
      COPILOT_PAT:
        required: true

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  health-check:
    name: ðŸ¥ README Health Check
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ“¦ Install GitHub Copilot CLI
        run: |
          curl -fsSL https://gh.io/copilot-install | bash
          echo "$HOME/.local/bin" >> $GITHUB_PATH
          echo "--- Copilot CLI version ---"
          $HOME/.local/bin/copilot --version 2>/dev/null || echo "(version flag not supported)"

      - name: ðŸ¥ Analyze README health
        env:
          GH_TOKEN: ${{ secrets.COPILOT_PAT }}
          FIX_MODE: ${{ inputs.fix_mode || 'report-only' }}
        run: |
          export PATH="$HOME/.local/bin:$PATH"

          copilot -p "
          You are a README Health Checker for the repository '${{ github.repository }}'.
          Your job is to analyze all README files in the repository, check their accuracy
          and completeness, and either report issues or fix them.

          CONFIGURATION:
          - Fix mode: $FIX_MODE
            - 'report-only': create an issue with findings
            - 'auto-fix': create a PR with fixes

          Follow these steps IN ORDER:

          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          STEP 1 â€” FIND ALL README FILES
          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          - Scan the repository for all README files: README.md, README.es.md,
            docs/README.md, etc.
          - Note the language of each README (English, Spanish, etc.).

          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          STEP 2 â€” ANALYZE PROJECT STATE
          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          - Scan the actual project structure (directories, key files, technologies).
          - List all workflows in .github/workflows/.
          - List all dependencies from package.json, composer.json, etc.
          - Note the actual features and configuration options.

          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          STEP 3 â€” CHECK STRUCTURAL COMPLETENESS
          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          For each README, verify it includes:
          - [ ] Project title and description
          - [ ] Badges (if applicable â€” build status, coverage, version)
          - [ ] Prerequisites / requirements
          - [ ] Installation instructions
          - [ ] Usage / quick start guide
          - [ ] Configuration options documented
          - [ ] Project structure (if >10 files)
          - [ ] Contributing guidelines (or link to CONTRIBUTING.md)
          - [ ] License information
          - [ ] Link to other language versions

          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          STEP 4 â€” CHECK ACCURACY
          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          Compare the README content against the actual project:

          a) **Project structure**: Does the tree/list match the actual directory layout?
             Check for missing directories, renamed files, or deleted items.

          b) **Features list**: Does it mention all workflows/features that actually exist?
             Are there features listed that have been removed?

          c) **Installation instructions**: Are the commands correct and up to date?
             Would they work if someone followed them right now?

          d) **Configuration**: Are all environment variables, secrets, and options documented?
             Do the documented defaults match the actual defaults?

          e) **Technology list**: Does it match the actual dependencies and tools used?

          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          STEP 5 â€” CHECK LINKS AND BADGES
          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          - Extract all URLs from the README files.
          - For each URL, determine if it is likely still valid:
            - GitHub links: check if the referenced repo, file, or path exists
            - Documentation links: verify the domain is still active
            - Badge URLs: check if they follow current badge service formats
          - Flag any links that appear broken or outdated.

          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          STEP 6 â€” CHECK MULTILINGUAL CONSISTENCY
          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          If multiple README versions exist (e.g., README.md and README.es.md):
          - Compare their section structure â€” they should have the same sections.
          - Check that feature lists, project structure, and configuration tables match.
          - Flag any section present in one but missing in the other.
          - Flag any content that is outdated in one language vs the other.

          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          STEP 7 â€” GENERATE HEALTH REPORT
          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          Create a health report with a score:

          ## ðŸ¥ README Health Report

          **Overall Score: X/100**

          | Category | Score | Issues |
          |----------|-------|--------|
          | Completeness | X/25 | ... |
          | Accuracy | X/25 | ... |
          | Links & Badges | X/25 | ... |
          | Multilingual Sync | X/25 | ... |

          ### ðŸ”´ Critical Issues
          (Issues that would confuse or mislead users)

          ### ðŸŸ¡ Important Issues
          (Missing sections or outdated information)

          ### ðŸŸ¢ Minor Issues
          (Nice-to-have improvements)

          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          STEP 8 â€” APPLY FIXES OR CREATE REPORT
          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

          **If FIX_MODE is 'report-only':**
          - Use the GitHub MCP Server to create an issue with the health report.
          - Title: 'ðŸ¥ README Health Check â€” [MONTH YEAR]'
          - Assign the label 'ðŸ“– documentation' if it exists.

          **If FIX_MODE is 'auto-fix':**
          - Create a new branch: 'readme-health-fix/YYYYMMDD'
          - Edit each README file to fix all ðŸ”´ and ðŸŸ¡ issues.
          - Update the project structure section to match reality.
          - Fix broken links where possible.
          - Sync multilingual versions.
          - Push the changes and create a PR:
            - Title: 'ðŸ¥ Fix README health issues'
            - Body: include the full health report and a list of changes made
          - Do NOT fix ðŸŸ¢ issues in auto-fix mode to keep the PR focused.

          IMPORTANT GUIDELINES:
          - Be thorough but practical â€” focus on issues that affect users
          - Don't rewrite well-written sections â€” only fix what's wrong
          - Respect the existing writing style and tone
          - If the README is healthy (score >90), report it positively and skip creating an issue
          - Always preserve the README's original structure and formatting choices
          " --allow-all-tools --model claude-opus-4.6
          exit_code=$?

          if [ $exit_code -ne 0 ]; then
            echo "::error::Copilot CLI failed with exit code $exit_code"
            exit $exit_code
          fi

          echo "âœ… README health check completed"
