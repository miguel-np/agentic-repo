name: "üîç PR Code Reviewer"

on:
  pull_request:
    types: [opened, synchronize]
  workflow_call:
    inputs:
      pr_number:
        description: 'Pull request number'
        required: true
        type: string
      pr_author:
        description: 'Pull request author login'
        required: true
        type: string
      base_ref:
        description: 'Base branch of the PR'
        required: true
        type: string
      head_ref:
        description: 'Head branch of the PR'
        required: true
        type: string
      author_filter:
        description: 'Who can trigger this workflow: owner_only, collaborators, or all'
        required: false
        type: string
        default: 'collaborators'
      model:
        description: 'Copilot model to use'
        required: false
        type: string
        default: 'claude-sonnet-4.6'
    secrets:
      COPILOT_PAT:
        required: true

permissions:
  contents: read
  pull-requests: write

# Cancel in-progress runs for the same PR to avoid wasting Actions minutes
# when multiple commits are pushed in quick succession.
concurrency:
  group: ${{ github.repository }}-pr-review-${{ github.event.pull_request.number || inputs.pr_number }}
  cancel-in-progress: true

jobs:
  review-pr:
    name: "üîç AI Code Review"
    runs-on: ubuntu-latest
    timeout-minutes: 12

    steps:
      - name: "üîÑ Skip if triggered by a docs auto-commit"
        id: loop_guard
        env:
          GH_TOKEN: ${{ secrets.COPILOT_PAT || github.token }}
          PR_NUMBER: ${{ inputs.pr_number || github.event.pull_request.number }}
          REPO: ${{ github.repository }}
        run: |
          # Skip review when the latest push was a [skip ci] commit from continuous-docs.
          # This avoids wasting an expensive LLM review on auto-generated doc changes.
          HEAD_MSG=$(gh api "repos/${REPO}/pulls/${PR_NUMBER}/commits" \
            --jq '.[-1].commit.message' 2>/dev/null || echo "")
          if echo "$HEAD_MSG" | grep -qi '\[skip ci\]'; then
            echo "skip=true" >> "$GITHUB_OUTPUT"
            echo "Head commit contains [skip ci] ‚Äî skipping review."
          else
            echo "skip=false" >> "$GITHUB_OUTPUT"
          fi

      - name: "üîê Verify author is allowed"
        if: steps.loop_guard.outputs.skip != 'true'
        id: author_check
        uses: ./.github/actions/check-author
        with:
          author: ${{ inputs.pr_author || github.event.pull_request.user.login }}
          author_filter: ${{ inputs.author_filter || 'collaborators' }}
          repo_owner: ${{ github.repository_owner }}
          repo_full: ${{ github.repository }}
          token: ${{ secrets.COPILOT_PAT || github.token }}

      - name: "üì• Checkout repository"
        if: steps.loop_guard.outputs.skip != 'true' && steps.author_check.outputs.allowed == 'true'
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: "üì¶ Install GitHub Copilot CLI"
        if: steps.loop_guard.outputs.skip != 'true' && steps.author_check.outputs.allowed == 'true'
        uses: ./.github/actions/install-copilot

      - name: "üîç Review PR code changes"
        if: steps.loop_guard.outputs.skip != 'true' && steps.author_check.outputs.allowed == 'true'
        env:
          GH_TOKEN: ${{ secrets.COPILOT_PAT }}
          PR_NUMBER: ${{ inputs.pr_number || github.event.pull_request.number }}
          REPO_NAME: ${{ github.repository }}
          MODEL: ${{ inputs.model || 'claude-sonnet-4.6' }}
        run: |
          export PATH="$HOME/.local/bin:$PATH"

          PROMPT=$(cat <<'PROMPT_EOF'
          You are an expert Code Reviewer for the repository.
          Your job is to review the code changes in a pull request and provide constructive,
          actionable feedback as inline review comments and a summary review.

          Use the GitHub MCP Server to read the full PR details and diff by number ‚Äî do NOT rely
          on any pre-filled title or body text. Fetch the PR fresh from the API.

          Follow these steps IN ORDER:

          ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
          STEP 1 ‚Äî UNDERSTAND THE PROJECT CONTEXT
          ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
          - Read the repository README to understand the project, its architecture, and conventions.
          - Read AGENTS.md, CONTRIBUTING.md, or any coding standards files if they exist.
          - Identify the languages, frameworks, and key patterns used.

          ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
          STEP 2 ‚Äî ANALYZE THE FULL DIFF
          ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
          - Use the GitHub MCP Server to get the complete diff of the PR.
          - Read each changed file carefully. Understand what the change does and why.
          - If the diff is large, prioritize:
            a) New files and new public APIs
            b) Security-sensitive changes (auth, crypto, input handling)
            c) Complex logic changes
            d) Configuration and infrastructure changes

          ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
          STEP 3 ‚Äî REVIEW FOR CORRECTNESS
          ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
          Check each change for:
          - Logic errors or off-by-one mistakes
          - Unhandled edge cases (null, empty, negative, overflow)
          - Missing error handling or silent failures
          - Broken or missing return values
          - Race conditions or concurrency issues
          - Incorrect API usage based on the framework conventions

          ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
          STEP 4 ‚Äî REVIEW FOR SECURITY
          ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
          Check for:
          - SQL injection, XSS, command injection, path traversal
          - Hardcoded secrets, API keys, or credentials
          - Missing input validation or sanitization
          - Missing authentication or authorization checks
          - Insecure cryptographic patterns
          - Sensitive data exposure in logs or error messages
          - CSRF vulnerabilities on state-changing operations

          ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
          STEP 5 ‚Äî REVIEW FOR PERFORMANCE
          ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
          Check for:
          - N+1 query patterns
          - Missing database indexes for new queries
          - Unbounded loops or missing pagination
          - Large memory allocations or unnecessary copies
          - Missing caching opportunities
          - Blocking operations in async contexts

          ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
          STEP 6 ‚Äî REVIEW FOR MAINTAINABILITY
          ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
          Check for:
          - Code duplication that should be extracted
          - Functions or methods that are too long (>50 lines)
          - Poor naming of variables, functions, or classes
          - Missing or outdated comments on complex logic
          - Inconsistency with the project's existing code style
          - Missing type annotations or type safety

          ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
          STEP 7 ‚Äî POST INLINE REVIEW COMMENTS
          ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
          For each issue found, use the GitHub MCP Server to create an inline review comment
          on the specific file and line where the issue exists.

          Each comment MUST follow this format:
          **[SEVERITY]** Brief title

          Explanation of the issue and why it matters.

          ```suggestion
          // Suggested fix (if applicable)
          ```

          Severity levels:
          - üî¥ **Critical** ‚Äî Must fix before merge (security, data loss, crash)
          - üü° **Warning** ‚Äî Should fix (bugs, performance, bad patterns)
          - üîµ **Suggestion** ‚Äî Nice to have (style, naming, readability)
          - üí° **Nitpick** ‚Äî Optional (minor style preferences)

          IMPORTANT:
          - Only post comments for genuine issues. Do NOT comment on correct code.
          - Maximum 15 inline comments to avoid overwhelming the author.
          - Prioritize üî¥ and üü° issues. Only include üîµ and üí° if there are few real issues.

          ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
          STEP 8 ‚Äî POST REVIEW SUMMARY
          ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
          Use the GitHub MCP Server to add a comment on the PR with an overall
          review summary:

          > üîç **Code Review Summary**
          >
          > **Overall Assessment:** [Looks good / Needs minor changes / Needs significant changes]
          >
          > | Category | Issues Found |
          > |----------|-------------|
          > | üî¥ Critical | X |
          > | üü° Warning | X |
          > | üîµ Suggestion | X |
          > | üí° Nitpick | X |
          >
          > **Key Findings:**
          > - (list the top 3-5 most important items)
          >
          > **What looks good:**
          > - (list 2-3 positive aspects of the code)
          >
          > ---
          > ü§ñ *This review was automatically generated by Copilot CLI.*
          > *Please use your judgment ‚Äî AI reviews complement but don't replace human review.*

          IMPORTANT GUIDELINES:
          - Be constructive, not critical. The goal is to help, not to lecture.
          - Acknowledge good practices when you see them.
          - If the PR is small or trivial, keep the review brief.
          - If the code is clean and well-written, say so ‚Äî not every PR needs criticism.
          - NEVER approve or request changes via the review API ‚Äî only leave comments.
          - Focus on objective issues, not style preferences (unless they violate project conventions).
          PROMPT_EOF
          )

          MAX_RETRIES=2
          RETRY_DELAY=10
          for attempt in $(seq 0 $MAX_RETRIES); do
            if [ "$attempt" -gt 0 ]; then
              echo "::warning::Copilot CLI attempt $attempt failed. Retrying in ${RETRY_DELAY}s..."
              sleep $RETRY_DELAY
              RETRY_DELAY=$((RETRY_DELAY * 2))
            fi
            timeout 420 copilot -p "Repository: ${REPO_NAME}. PR number: #${PR_NUMBER}. ${PROMPT}" \
              --allow-all-tools --model "$MODEL" && break
            exit_code=$?
            if [ "$attempt" -eq "$MAX_RETRIES" ]; then
              echo "::error::Copilot CLI failed after $((MAX_RETRIES + 1)) attempts (exit code $exit_code) for PR #$PR_NUMBER"
              exit $exit_code
            fi
          done

          echo "‚úÖ Code review completed for PR #$PR_NUMBER"
