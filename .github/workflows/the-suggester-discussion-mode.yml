name: "\uD83D\uDCA1 Copilot Suggester (Discussion Mode)"

on:
  # schedule:
  #   - cron: "0 9 * * 1" # Monday 9:00 UTC
  workflow_dispatch:
    inputs:
      suggestion_type:
        description: 'Type of suggestions to look for'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - security
          - performance
          - refactoring
          - testing
          - documentation
          - architecture
          - configuration
          - bugs
          - maintainability
          - ux-design
          - readme
      analyze_ui:
        description: 'Attempt to build, run, and analyze the application UI via Playwright'
        required: false
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'
  workflow_call:
    inputs:
      suggestion_type:
        description: 'Type of suggestions to look for'
        required: false
        type: string
        default: 'all'
      analyze_ui:
        description: 'Attempt to build, run, and analyze the application UI via Playwright'
        required: false
        type: string
        default: 'true'
      model:
        description: 'Copilot model to use'
        required: false
        type: string
        default: 'claude-sonnet-4'
    secrets:
      COPILOT_PAT:
        required: true

permissions:
  contents: read
  discussions: write

jobs:
  review:
    name: "\uD83D\uDD0D Analyze & Create Discussion Ideas"
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: "\uD83D\uDCE5 Checkout repository"
        uses: actions/checkout@v4

      - name: "\uD83D\uDCE6 Install GitHub Copilot CLI"
        uses: ./.github/actions/install-copilot

      - name: "\uD83D\uDD27 Configure Playwright MCP Server"
        if: inputs.analyze_ui != 'false'
        run: |
          mkdir -p ~/.copilot
          cat > ~/.copilot/mcp-config.json << 'EOF'
          {
            "servers": {
              "playwright": {
                "command": "npx",
                "args": ["@playwright/mcp@0.0.29"]
              }
            }
          }
          EOF
          echo "âœ… Playwright MCP Server configured"

      - name: "\uD83E\uDD16 Analyze code and create discussions with Copilot CLI"
        env:
          GH_TOKEN: ${{ secrets.COPILOT_PAT }}
          SUGGESTION_TYPE: ${{ inputs.suggestion_type || 'all' }}
          ANALYZE_UI: ${{ inputs.analyze_ui || 'true' }}
          REPO_NAME: ${{ github.repository }}
          MODEL: ${{ inputs.model || 'claude-sonnet-4' }}
        run: |
          export PATH="$HOME/.local/bin:$PATH"

          # Map the user-selected suggestion type to a human-readable category list
          if [ "$SUGGESTION_TYPE" = "all" ]; then
            CATEGORIES="Security, Performance, Refactoring, Testing, Documentation, Architecture, Configuration, Bugs, Maintainability, UX/Design, and README improvements"
          else
            CATEGORIES="$SUGGESTION_TYPE"
          fi

          # Build UI analysis block only when enabled
          if [ "$ANALYZE_UI" = "true" ]; then
            UI_INSTRUCTION="ALSO perform UI analysis: detect project type, install deps, build, start a local server, use the Playwright MCP Server to navigate the app, take screenshots, and analyze visual design quality, usability, accessibility, and favicon. Include UX findings in your suggestions."
          else
            UI_INSTRUCTION="UI analysis was disabled for this run. Skip any browser-based analysis."
          fi

          PROMPT=$(cat <<'PROMPT_EOF'
          You are analyzing the repository to find improvement suggestions.
          Follow these steps:

          1. FIRST: Use the GitHub MCP Server to list ALL available discussion categories in this repository.
             Look specifically for a category named 'Ideas' or similar (like 'ðŸ’¡ Ideas', 'Feature requests', etc.).
             SAVE the category ID â€” you MUST use it when creating discussions.

          2. SECOND: Use the GitHub MCP Server to review the last 5 discussions in this repository to understand:
             - The title structure (emojis, prefixes, etc.)
             - The body structure (sections, formatting)

          3. THIRD: Analyze the README.md file:
             - Check if it has a proper project description
             - Check if it includes screenshots of the application
             - Check if it has installation instructions
             - Check if it has usage instructions
             - Check if it has contribution guidelines
             - Suggest improvements including adding screenshots or better documentation

          4. FOURTH: Analyze all the code in this repository looking for improvements in the requested categories.

          5. FIFTH: Before creating any discussion, use the GitHub MCP Server to search for existing
             ISSUES AND DISCUSSIONS in this repository that might be related to each suggestion.
             - Search using relevant keywords from your suggestion
             - Check both open AND closed issues
             - If an issue or discussion already exists that covers the same topic, DO NOT create a duplicate
             - Only proceed if NO related item exists

          6. SIXTH: For each important suggestion that has NO related existing issue or discussion,
             create a DISCUSSION in this repository.
             CRITICAL REQUIREMENTS for each discussion:
             - Category: Use the 'Ideas' category (or equivalent found in step 1)
             - Title: Follow EXACTLY the same style as existing discussions
             - Language: If there are no prior discussions, write in English.
               If there are prior discussions, match the language used in those discussions.
             - Body: Use the SAME structure as existing discussions
             - Include a section explaining what the suggestion is and why it would improve the codebase
             - For UX/Design suggestions, reference the screenshots you took and describe what you observed
             - For README suggestions, include recommendations for adding screenshots and better documentation
             - Footer: Include 'This discussion was automatically generated by Copilot CLI'

             LABELS ARE MANDATORY:
             After creating each discussion, you MUST add labels to it using the GitHub MCP Server.
             - First, list available labels in the repository
             - If the label 'ðŸ¤– copilot-suggestion' does NOT exist yet, CREATE it first
               (use color '7057ff' and description 'Automatically generated suggestion by Copilot')
             - EVERY discussion MUST include the 'ðŸ¤– copilot-suggestion' label
             - Add additional labels based on the suggestion type
               (e.g., 'enhancement', 'security', 'performance', 'documentation', 'design', etc.)

          QUALITY OVER QUANTITY:
          - Only create discussions for suggestions that provide REAL VALUE to the project
          - Do NOT create discussions just to create something â€” if the codebase is already in
            good shape, it is OK to create zero discussions
          - Skip minor nitpicks, trivial improvements, or changes that don't significantly
            impact the project
          - A suggestion is worth a discussion ONLY if it fixes a real problem, improves security,
            significantly enhances UX, or adds important missing functionality
          - If you don't find any meaningful suggestions, report that the codebase is in good
            condition and no discussions were created

          Create individual discussions for each important suggestion, not a single discussion
          with everything.
          REMEMBER: Skip any suggestion that already has a related issue or discussion!
          CRITICAL: After creating each discussion, you MUST add labels to it.
          PROMPT_EOF
          )

          copilot -p "Repository: ${REPO_NAME}. Categories to analyze: ${CATEGORIES}. ${UI_INSTRUCTION} ${PROMPT}" \
            --allow-all-tools --model "$MODEL"
          exit_code=$?

          if [ $exit_code -ne 0 ]; then
            echo "::error::Copilot CLI failed with exit code $exit_code"
            exit $exit_code
          fi

          echo "âœ… Copilot CLI analysis completed"
