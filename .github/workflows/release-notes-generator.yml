name: ðŸ“‹ Release Notes Generator

on:
  release:
    types: [created]
  workflow_dispatch:
    inputs:
      tag_name:
        description: 'Tag name to generate release notes for (e.g., v1.2.0)'
        required: true
        type: string
      previous_tag:
        description: 'Previous tag to compare against (leave empty for auto-detect)'
        required: false
        type: string
        default: ''
  workflow_call:
    inputs:
      tag_name:
        description: 'Tag name to generate release notes for'
        required: true
        type: string
      previous_tag:
        description: 'Previous tag to compare against (leave empty for auto-detect)'
        required: false
        type: string
        default: ''
      model:
        description: 'Copilot model to use'
        required: false
        type: string
        default: 'claude-sonnet-4.6'
    secrets:
      COPILOT_PAT:
        required: true

permissions:
  contents: write

# Each tag is independent â€” do not cancel; each release needs its notes generated.
concurrency:
  group: release-notes-${{ github.event.release.tag_name || inputs.tag_name }}
  cancel-in-progress: false

jobs:
  generate-notes:
    name: ðŸ“‹ Generate Release Notes
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ“¦ Install GitHub Copilot CLI
        uses: ./.github/actions/install-copilot

      - name: ðŸ“‹ Generate and update release notes
        env:
          GH_TOKEN: ${{ secrets.COPILOT_PAT }}
          TAG_NAME: ${{ inputs.tag_name || github.event.release.tag_name }}
          PREVIOUS_TAG: ${{ inputs.previous_tag || '' }}
          REPO_NAME: ${{ github.repository }}
          MODEL: ${{ inputs.model || 'claude-sonnet-4.6' }}
        run: |
          export PATH="$HOME/.local/bin:$PATH"

          PROMPT=$(cat <<'PROMPT_EOF'
          You are a Release Notes Generator for the repository.
          Your job is to analyze all changes since the previous release and generate
          comprehensive, well-structured release notes.

          Follow these steps IN ORDER:

          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          STEP 1 â€” DETERMINE THE COMPARISON RANGE
          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          - If a previous tag was provided, use it as the comparison base.
          - Otherwise, list all releases and find the one immediately before the current tag.
          - If no previous release exists, use the first commit.

          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          STEP 2 â€” GATHER ALL CHANGES
          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          - List all commits between the two tags.
          - List all PRs merged between the two tags.
          - List all contributors who authored commits in this range.

          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          STEP 3 â€” CATEGORIZE CHANGES
          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          Classify each change into:
          - ðŸ’¥ Breaking Changes, âœ¨ New Features, ðŸ› Bug Fixes, âš¡ Performance,
            ðŸ”’ Security, ðŸ“ Documentation, â™»ï¸ Refactoring, ðŸ§ª Testing,
            ðŸ—ï¸ Infrastructure, â¬†ï¸ Dependencies

          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          STEP 4 â€” WRITE THE RELEASE NOTES
          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          Generate notes with: summary, categorized sections (omit empty ones),
          contributors list, and full changelog link.
          For breaking changes, ALWAYS include a migration guide.
          Credit authors with @username and link PRs with #NUMBER.

          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          STEP 5 â€” UPDATE THE RELEASE
          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          Update the release with the generated notes. If no release exists, create one.

          IMPORTANT GUIDELINES:
          - Be accurate â€” only include changes that actually happened
          - Exclude trivial commits (merge commits, version bumps)
          - Write in English regardless of commit message language
          PROMPT_EOF
          )

          copilot -p "Repository: ${REPO_NAME}. Tag: ${TAG_NAME}. Previous tag: ${PREVIOUS_TAG:-auto-detect}. ${PROMPT}" \
            --allow-all-tools --model "$MODEL"
          exit_code=$?

          if [ $exit_code -ne 0 ]; then
            echo "::error::Copilot CLI failed with exit code $exit_code"
            exit $exit_code
          fi

          echo "âœ… Release notes generated for $TAG_NAME"
