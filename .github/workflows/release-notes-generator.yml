name: ğŸ“‹ Release Notes Generator

on:
  release:
    types: [created]
  workflow_dispatch:
    inputs:
      tag_name:
        description: 'Tag name to generate release notes for (e.g., v1.2.0)'
        required: true
        type: string
      previous_tag:
        description: 'Previous tag to compare against (leave empty for auto-detect)'
        required: false
        type: string
        default: ''
  workflow_call:
    inputs:
      tag_name:
        description: 'Tag name to generate release notes for'
        required: true
        type: string
      previous_tag:
        description: 'Previous tag to compare against (leave empty for auto-detect)'
        required: false
        type: string
        default: ''
    secrets:
      COPILOT_PAT:
        required: true

permissions:
  contents: write

jobs:
  generate-notes:
    name: ğŸ“‹ Generate Release Notes
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ“¦ Install GitHub Copilot CLI
        run: |
          curl -fsSL https://gh.io/copilot-install | bash
          echo "$HOME/.local/bin" >> $GITHUB_PATH
          echo "--- Copilot CLI version ---"
          $HOME/.local/bin/copilot --version 2>/dev/null || echo "(version flag not supported)"

      - name: ğŸ“‹ Generate and update release notes
        env:
          GH_TOKEN: ${{ secrets.COPILOT_PAT }}
          TAG_NAME: ${{ inputs.tag_name || github.event.release.tag_name }}
          PREVIOUS_TAG: ${{ inputs.previous_tag || '' }}
        run: |
          export PATH="$HOME/.local/bin:$PATH"

          copilot -p "
          You are a Release Notes Generator for the repository '${{ github.repository }}'.
          Your job is to analyze all changes since the previous release and generate
          comprehensive, well-structured release notes.

          RELEASE DETAILS:
          - Tag: $TAG_NAME
          - Previous tag (if provided): $PREVIOUS_TAG

          Follow these steps IN ORDER:

          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          STEP 1 â€” DETERMINE THE COMPARISON RANGE
          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          - If a previous tag was provided ('$PREVIOUS_TAG'), use it as the comparison base.
          - If not, use the GitHub MCP Server to list all releases in this repository.
          - Find the release immediately before '$TAG_NAME' and use its tag as the base.
          - If there is no previous release, use the first commit of the repository.
          - Save the comparison range: PREVIOUS_TAG..TAG_NAME

          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          STEP 2 â€” GATHER ALL CHANGES
          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          - Use the GitHub MCP Server to list all commits between the two tags.
          - Use the GitHub MCP Server to list all PRs merged between the two tags.
          - For each PR, read its title, description, labels, and linked issues.
          - List all contributors who authored commits in this range.

          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          STEP 3 â€” CATEGORIZE CHANGES
          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          Classify each change into one of these categories based on PR labels,
          commit messages, and PR descriptions:

          - ğŸ’¥ **Breaking Changes** â€” changes that break backward compatibility
          - âœ¨ **New Features** â€” new functionality added
          - ğŸ› **Bug Fixes** â€” bugs that were fixed
          - âš¡ **Performance** â€” performance improvements
          - ğŸ”’ **Security** â€” security fixes or improvements
          - ğŸ“ **Documentation** â€” documentation updates
          - â™»ï¸ **Refactoring** â€” code improvements without behavior changes
          - ğŸ§ª **Testing** â€” new or improved tests
          - ğŸ—ï¸ **Infrastructure** â€” CI/CD, build, or tooling changes
          - â¬†ï¸ **Dependencies** â€” dependency updates

          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          STEP 4 â€” WRITE THE RELEASE NOTES
          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          Generate release notes in this format:

          # Release $TAG_NAME

          > Brief 2-3 sentence summary of the most important changes in this release.

          ## ğŸ’¥ Breaking Changes
          - Description of breaking change (#PR_NUMBER) by @author
            - **Migration guide:** How to adapt to this change

          ## âœ¨ New Features
          - Feature description (#PR_NUMBER) by @author

          ## ğŸ› Bug Fixes
          - Bug fix description (#PR_NUMBER) by @author

          ## âš¡ Performance
          - Improvement description (#PR_NUMBER) by @author

          ## ğŸ”’ Security
          - Security fix description (#PR_NUMBER) by @author

          (Include only sections that have entries. Omit empty sections.)

          ## ğŸ‘¥ Contributors
          Thanks to everyone who contributed to this release:
          @contributor1, @contributor2, @contributor3

          **Full Changelog:** https://github.com/OWNER/REPO/compare/PREVIOUS_TAG...$TAG_NAME

          ---

          FORMATTING RULES:
          - Each entry should be a single clear sentence
          - Always link to the PR number with #NUMBER
          - Credit the author with @username
          - Put the most impactful changes first within each section
          - For breaking changes, ALWAYS include a migration guide
          - Keep the summary concise but informative

          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          STEP 5 â€” UPDATE THE RELEASE
          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          - Use the GitHub MCP Server to update the release for tag '$TAG_NAME'
            with the generated release notes as the body.
          - If no release exists for this tag (manual workflow_dispatch), create one.
          - Preserve any existing release assets or settings.

          IMPORTANT GUIDELINES:
          - Be accurate â€” only include changes that actually happened in this range
          - Don't invent or hallucinate changes
          - If a commit is trivial (merge commits, version bumps), exclude it
          - Group related changes from the same PR together
          - If the release has very few changes, keep the notes brief
          - Write in English regardless of the commit message language
          " --allow-all-tools --model claude-opus-4.6
          exit_code=$?

          if [ $exit_code -ne 0 ]; then
            echo "::error::Copilot CLI failed with exit code $exit_code"
            exit $exit_code
          fi

          echo "âœ… Release notes generated for $TAG_NAME"
