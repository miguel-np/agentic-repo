name: âœ¨ PR Quality Enhancer

on:
  pull_request:
    types: [opened]
  workflow_call:
    inputs:
      pr_number:
        description: 'Pull request number'
        required: true
        type: string
      pr_title:
        description: 'Pull request title'
        required: true
        type: string
      pr_body:
        description: 'Pull request body'
        required: false
        type: string
        default: ''
      pr_author:
        description: 'Pull request author login'
        required: true
        type: string
      base_ref:
        description: 'Base branch of the PR'
        required: true
        type: string
      head_ref:
        description: 'Head branch of the PR'
        required: true
        type: string
      author_filter:
        description: 'Who can trigger this workflow: owner_only, collaborators, or all'
        required: false
        type: string
        default: 'owner_only'
    secrets:
      COPILOT_PAT:
        required: true

permissions:
  contents: read
  pull-requests: write

jobs:
  enhance-pr:
    name: âœ¨ Enhance PR Quality
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ” Verify author is allowed
        id: author_check
        env:
          EVENT_NAME: ${{ github.event_name }}
          REPO_OWNER: ${{ github.repository_owner }}
          REPO_FULL: ${{ github.repository }}
          PR_AUTHOR: ${{ github.event.pull_request.user.login }}
          INPUT_AUTHOR: ${{ inputs.pr_author }}
          AUTHOR_FILTER: ${{ inputs.author_filter || 'owner_only' }}
          GH_TOKEN: ${{ secrets.COPILOT_PAT || github.token }}
        run: |
          author="$PR_AUTHOR"
          if [ "$EVENT_NAME" = "workflow_call" ]; then
            author="$INPUT_AUTHOR"
          fi

          allowed="false"
          case "$AUTHOR_FILTER" in
            all)
              allowed="true"
              ;;
            collaborators)
              perm=$(gh api "repos/${REPO_FULL}/collaborators/${author}/permission" --jq '.permission' 2>/dev/null || echo "none")
              if [ "$perm" = "admin" ] || [ "$perm" = "write" ] || [ "$perm" = "maintain" ]; then
                allowed="true"
              fi
              ;;
            owner_only|*)
              if [ "$author" = "$REPO_OWNER" ]; then
                allowed="true"
              fi
              ;;
          esac

          echo "allowed=$allowed" >> "$GITHUB_OUTPUT"
          if [ "$allowed" != "true" ]; then
            echo "Skipping: author '$author' not allowed under filter '$AUTHOR_FILTER'."
          fi

      - name: ðŸ“¥ Checkout repository
        if: ${{ steps.author_check.outputs.allowed == 'true' }}
        uses: actions/checkout@v4

      - name: ðŸ“¦ Install GitHub Copilot CLI
        if: ${{ steps.author_check.outputs.allowed == 'true' }}
        run: |
          curl -fsSL https://gh.io/copilot-install | bash
          echo "$HOME/.local/bin" >> $GITHUB_PATH
          echo "--- Copilot CLI version ---"
          $HOME/.local/bin/copilot --version 2>/dev/null || echo "(version flag not supported)"

      - name: âœ¨ Enhance PR title and description
        if: ${{ steps.author_check.outputs.allowed == 'true' }}
        env:
          GH_TOKEN: ${{ secrets.COPILOT_PAT }}
          PR_NUMBER: ${{ inputs.pr_number || github.event.pull_request.number }}
          PR_TITLE: ${{ inputs.pr_title || github.event.pull_request.title }}
          PR_BODY: ${{ inputs.pr_body || github.event.pull_request.body }}
          PR_AUTHOR: ${{ inputs.pr_author || github.event.pull_request.user.login }}
          BASE_REF: ${{ inputs.base_ref || github.event.pull_request.base.ref }}
          HEAD_REF: ${{ inputs.head_ref || github.event.pull_request.head.ref }}
        run: |
          export PATH="$HOME/.local/bin:$PATH"

          copilot -p "
          You are an expert Pull Request Quality Enhancer for the repository '${{ github.repository }}'.
          Your job is to take a newly opened PR and improve its title and description so it is clear,
          well-structured, and consistent with the project standards.

          PULL REQUEST DETAILS:
          - Number: #$PR_NUMBER
          - Author: @$PR_AUTHOR
          - Original Title: $PR_TITLE
          - Original Body: $PR_BODY
          - Base branch: $BASE_REF
          - Head branch: $HEAD_REF

          Follow these steps IN ORDER:

          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          STEP 1 â€” UNDERSTAND THE PROJECT CONTEXT
          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          - Read the repository README to understand what this project is about.
          - Read AGENTS.md or CONTRIBUTING.md if they exist.
          - Scan the source code structure to know what modules, files and technologies exist.
          - Use the GitHub MCP Server to list the last 5 merged PRs to learn the title conventions.

          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          STEP 2 â€” ANALYZE THE PR DIFF
          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          - Use the GitHub MCP Server to get the full diff of PR #$PR_NUMBER.
          - Identify ALL files changed, added, or deleted.
          - Understand the nature of the changes: bug fix, feature, refactoring, docs, CI/CD, etc.

          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          STEP 3 â€” DETECT LANGUAGE & TRANSLATE
          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          - Detect the language of the original title and body.
          - If the title or body are in any language other than English, translate to clear professional English.
          - Preserve the original meaning and technical details.

          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          STEP 4 â€” ENHANCE THE TITLE
          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          Create an improved title following these rules:
          - Start with a relevant emoji:
            ðŸ› bug fix, âœ¨ feature, ðŸ“ docs, ðŸŽ¨ styling, â™»ï¸ refactoring,
            ðŸ”’ security, âš¡ performance, ðŸ§ª tests, ðŸ—ï¸ architecture,
            ðŸš€ CI/CD, â¬†ï¸ dependencies, ðŸ”§ config
          - Keep it concise but descriptive (5-12 words after the emoji)
          - Use imperative mood ('Add dark mode' not 'Adding dark mode')
          - Do NOT include PR type prefixes like '[BUG]' or '[FEATURE]'

          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          STEP 5 â€” ENHANCE THE DESCRIPTION
          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          Rewrite the PR body using this structure:

          ## Summary
          A clear 2-3 sentence summary of what this PR does and why.

          ## Changes
          - Bullet list of specific changes made
          - Group related changes together
          - Reference specific files when helpful

          ## Related Issues
          - Link to any related issues using 'Closes #X' or 'Relates to #X'
          - Search the repository issues to find related ones

          ## Testing
          - How were these changes tested?
          - What should reviewers check?

          ## Screenshots (if applicable)
          - If there are UI changes, note that screenshots would be helpful

          ---
          > âœ¨ *This PR description was automatically enhanced by Copilot CLI. Original author: @$PR_AUTHOR*

          ADAPT the sections based on the PR type:
          - For bug fixes: add a 'Root Cause' section
          - For features: add a 'Motivation' section
          - For refactoring: add a 'Before/After' section explaining the improvement
          - For small/trivial PRs: use a simpler structure with just Summary and Changes

          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          STEP 6 â€” FIND RELATED ISSUES
          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          - Use the GitHub MCP Server to search for issues related to this PR's topic.
          - Check both open and closed issues.
          - If the branch name contains an issue number (e.g., 'fix/42-bug-name'), link to that issue.
          - Add 'Closes #X' for issues this PR clearly fixes.
          - Add 'Relates to #X' for issues that are related but not fully resolved.

          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          STEP 7 â€” UPDATE THE PR
          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          Use the GitHub MCP Server to UPDATE PR #$PR_NUMBER with:
          - The new enhanced title
          - The new enhanced body
          DO NOT create a new PR. UPDATE the existing one.

          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          STEP 8 â€” ADD A FRIENDLY COMMENT
          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          Use the GitHub MCP Server to add a comment on PR #$PR_NUMBER with a brief,
          friendly summary of what was improved. Example:

          > ðŸ¤– **PR enhanced!** I've improved this pull request by:
          > - Rewrote the title with a descriptive emoji prefix
          > - Structured the description with Summary, Changes, and Testing sections
          > - Linked related issues (#12, #15)
          >
          > Feel free to edit if anything needs adjusting!

          IMPORTANT GUIDELINES:
          - NEVER change the meaning or intent of the original PR description
          - ALWAYS preserve all technical details from the original
          - If the PR is already well-written with good structure, make only minimal improvements
          - Infer information from the diff â€” don't make up changes that aren't there
          - Be helpful, not intrusive
          " --allow-all-tools --model claude-opus-4.6
          exit_code=$?

          if [ $exit_code -ne 0 ]; then
            echo "::error::Copilot CLI failed with exit code $exit_code for PR #$PR_NUMBER"
            exit $exit_code
          fi

          echo "âœ… PR #$PR_NUMBER enhanced successfully"
