name: "\u2728 PR Quality Enhancer"

on:
  pull_request:
    types: [opened]
  workflow_call:
    inputs:
      pr_number:
        description: 'Pull request number'
        required: true
        type: string
      pr_author:
        description: 'Pull request author login'
        required: true
        type: string
      base_ref:
        description: 'Base branch of the PR'
        required: true
        type: string
      head_ref:
        description: 'Head branch of the PR'
        required: true
        type: string
      author_filter:
        description: 'Who can trigger this workflow: owner_only, collaborators, or all'
        required: false
        type: string
        default: 'owner_only'
      model:
        description: 'Copilot model to use'
        required: false
        type: string
        default: 'claude-sonnet-4.6'
    secrets:
      COPILOT_PAT:
        required: true

permissions:
  contents: read
  pull-requests: write

# Only run once per PR â€” if a new push triggers this while a run is in progress,
# cancel the old one (though this workflow only runs on [opened], the guard is cheap).
concurrency:
  group: pr-quality-${{ github.event.pull_request.number || inputs.pr_number }}
  cancel-in-progress: true

jobs:
  enhance-pr:
    name: "\u2728 Enhance PR Quality"
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: "\uD83D\uDD10 Verify author is allowed"
        id: author_check
        uses: ./.github/actions/check-author
        with:
          author: ${{ inputs.pr_author || github.event.pull_request.user.login }}
          author_filter: ${{ inputs.author_filter || 'owner_only' }}
          repo_owner: ${{ github.repository_owner }}
          repo_full: ${{ github.repository }}
          token: ${{ secrets.COPILOT_PAT || github.token }}

      - name: "\uD83D\uDCE5 Checkout repository"
        if: steps.author_check.outputs.allowed == 'true'
        uses: actions/checkout@v4

      - name: "\uD83D\uDCE6 Install GitHub Copilot CLI"
        if: steps.author_check.outputs.allowed == 'true'
        uses: ./.github/actions/install-copilot

      - name: "\u2728 Enhance PR title and description"
        if: steps.author_check.outputs.allowed == 'true'
        env:
          GH_TOKEN: ${{ secrets.COPILOT_PAT }}
          PR_NUMBER: ${{ inputs.pr_number || github.event.pull_request.number }}
          REPO_NAME: ${{ github.repository }}
          MODEL: ${{ inputs.model || 'claude-sonnet-4.6' }}
        run: |
          export PATH="$HOME/.local/bin:$PATH"

          PROMPT=$(cat <<'PROMPT_EOF'
          You are an expert Pull Request Quality Enhancer for the repository.
          Your job is to take a newly opened PR and improve its title and description so it is clear,
          well-structured, and consistent with the project standards.

          Use the GitHub MCP Server to read the full PR details by number â€” do NOT rely
          on any pre-filled title or body text. Fetch the PR fresh from the API.

          Follow these steps IN ORDER:

          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          STEP 1 â€” UNDERSTAND THE PROJECT CONTEXT
          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          - Read the repository README to understand what this project is about.
          - Read AGENTS.md or CONTRIBUTING.md if they exist.
          - Scan the source code structure to know what modules, files and technologies exist.
          - Use the GitHub MCP Server to list the last 5 merged PRs to learn the title conventions.

          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          STEP 2 â€” ANALYZE THE PR DIFF
          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          - Use the GitHub MCP Server to get the full diff of the PR.
          - Identify ALL files changed, added, or deleted.
          - Understand the nature of the changes: bug fix, feature, refactoring, docs, CI/CD, etc.

          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          STEP 3 â€” DETECT LANGUAGE & TRANSLATE
          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          - Detect the language of the original title and body.
          - If the title or body are in any language other than English, translate to clear professional English.
          - Preserve the original meaning and technical details.

          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          STEP 4 â€” ENHANCE THE TITLE
          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          Create an improved title following these rules:
          - Start with a relevant emoji:
            ðŸ› bug fix, âœ¨ feature, ðŸ“ docs, ðŸŽ¨ styling, â™»ï¸ refactoring,
            ðŸ”’ security, âš¡ performance, ðŸ§ª tests, ðŸ—ï¸ architecture,
            ðŸš€ CI/CD, â¬†ï¸ dependencies, ðŸ”§ config
          - Keep it concise but descriptive (5-12 words after the emoji)
          - Use imperative mood ('Add dark mode' not 'Adding dark mode')
          - Do NOT include PR type prefixes like '[BUG]' or '[FEATURE]'

          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          STEP 5 â€” ENHANCE THE DESCRIPTION
          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          Rewrite the PR body using this structure:

          ## Summary
          A clear 2-3 sentence summary of what this PR does and why.

          ## Changes
          - Bullet list of specific changes made
          - Group related changes together
          - Reference specific files when helpful

          ## Related Issues
          - Link to any related issues using 'Closes #X' or 'Relates to #X'
          - Search the repository issues to find related ones

          ## Testing
          - How were these changes tested?
          - What should reviewers check?

          ## Screenshots (if applicable)
          - If there are UI changes, note that screenshots would be helpful

          ---
          > âœ¨ *This PR description was automatically enhanced by Copilot CLI.*

          ADAPT the sections based on the PR type:
          - For bug fixes: add a 'Root Cause' section
          - For features: add a 'Motivation' section
          - For refactoring: add a 'Before/After' section explaining the improvement
          - For small/trivial PRs: use a simpler structure with just Summary and Changes

          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          STEP 6 â€” FIND RELATED ISSUES
          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          - Use the GitHub MCP Server to search for issues related to this PR's topic.
          - Check both open and closed issues.
          - If the branch name contains an issue number (e.g., 'fix/42-bug-name'), link to that issue.
          - Add 'Closes #X' for issues this PR clearly fixes.
          - Add 'Relates to #X' for issues that are related but not fully resolved.

          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          STEP 7 â€” UPDATE THE PR
          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          Use the GitHub MCP Server to UPDATE the PR with:
          - The new enhanced title
          - The new enhanced body
          DO NOT create a new PR. UPDATE the existing one.

          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          STEP 8 â€” ADD A FRIENDLY COMMENT
          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          Use the GitHub MCP Server to add a comment on the PR with a brief,
          friendly summary of what was improved. Example:

          > ðŸ¤– **PR enhanced!** I've improved this pull request by:
          > - Rewrote the title with a descriptive emoji prefix
          > - Structured the description with Summary, Changes, and Testing sections
          > - Linked related issues (#12, #15)
          >
          > Feel free to edit if anything needs adjusting!

          IMPORTANT GUIDELINES:
          - NEVER change the meaning or intent of the original PR description
          - ALWAYS preserve all technical details from the original
          - If the PR is already well-written with good structure, make only minimal improvements
          - Infer information from the diff â€” don't make up changes that aren't there
          - Be helpful, not intrusive
          PROMPT_EOF
          )

          copilot -p "Repository: ${REPO_NAME}. PR number: #${PR_NUMBER}. ${PROMPT}" \
            --allow-all-tools --model "$MODEL"
          exit_code=$?

          if [ $exit_code -ne 0 ]; then
            echo "::error::Copilot CLI failed with exit code $exit_code for PR #$PR_NUMBER"
            exit $exit_code
          fi

          echo "âœ… PR #$PR_NUMBER enhanced successfully"
