name: ğŸ” Duplicate Issue Detector

on:
  issues:
    types: [opened]
  workflow_call:
    inputs:
      issue_number:
        description: 'Issue number to check for duplicates'
        required: true
        type: string
      issue_author:
        description: 'Issue author login'
        required: true
        type: string
      author_filter:
        description: 'Who can trigger this workflow: owner_only, collaborators, or all'
        required: false
        type: string
        default: 'collaborators'
      model:
        description: 'Copilot model to use'
        required: false
        type: string
        default: 'gpt-4.1-mini'
    secrets:
      COPILOT_PAT:
        required: true

permissions:
  contents: read
  issues: write
  discussions: read

# Each issue is independent â€” do not cancel in-progress runs for other issues.
# Use cancel-in-progress: false to ensure every issue gets checked.
concurrency:
  group: ${{ github.repository }}-duplicate-detector-${{ github.event.issue.number || inputs.issue_number }}
  cancel-in-progress: false

jobs:
  detect-duplicates:
    name: ğŸ” Check for Duplicate Issues
    runs-on: ubuntu-latest
    timeout-minutes: 7

    steps:
      - name: ğŸ” Verify author is allowed
        id: author_check
        uses: ./.github/actions/check-author
        with:
          author: ${{ inputs.issue_author || github.event.issue.user.login }}
          author_filter: ${{ inputs.author_filter || 'collaborators' }}
          repo_owner: ${{ github.repository_owner }}
          repo_full: ${{ github.repository }}
          token: ${{ secrets.COPILOT_PAT || github.token }}

      - name: ğŸ“¥ Checkout repository
        if: steps.author_check.outputs.allowed == 'true'
        uses: actions/checkout@v4

      - name: ğŸ“¦ Install GitHub Copilot CLI
        if: steps.author_check.outputs.allowed == 'true'
        uses: ./.github/actions/install-copilot

      - name: ğŸ” Search for duplicate issues
        if: steps.author_check.outputs.allowed == 'true'
        env:
          GH_TOKEN: ${{ secrets.COPILOT_PAT }}
          ISSUE_NUMBER: ${{ inputs.issue_number || github.event.issue.number }}
          REPO_NAME: ${{ github.repository }}
          MODEL: ${{ inputs.model || 'gpt-4.1-mini' }}
        run: |
          export PATH="$HOME/.local/bin:$PATH"

          PROMPT=$(cat <<'PROMPT_EOF'
          You are a Duplicate Issue Detector for the repository.
          Your job is to check if a newly opened issue is a duplicate of an existing one
          and flag potential duplicates without being too aggressive.

          Use the GitHub MCP Server to read the issue details by number â€” do NOT rely
          on any pre-filled title or body text. Fetch the issue fresh from the API.

          Follow these steps IN ORDER:

          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          STEP 1 â€” EXTRACT KEY TOPICS
          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          - Read the issue title and body from the API.
          - Extract key topics, technologies, and concepts.
          - Generate 3-5 search queries that would match similar issues.

          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          STEP 2 â€” SEARCH FOR EXISTING ISSUES
          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          - Search BOTH open AND recently closed issues (last 90 days).
          - Also search for discussions covering the same topic.

          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          STEP 3 â€” ANALYZE SIMILARITY
          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          For each candidate:
          - ğŸ”´ High confidence duplicate (>80%): same problem, same context
          - ğŸŸ¡ Likely related (50-80%): same topic, different angle
          - ğŸŸ¢ Loosely related (20-50%): same area, different problem
          Exclude candidates below 20%.

          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          STEP 4 â€” DECIDE AND ACT
          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          - High confidence: post comment flagging duplicate, add 'duplicate' label if it exists
          - Likely related: post comment listing related issues (no duplicate label)
          - No duplicates: do nothing (exit silently)

          IMPORTANT GUIDELINES:
          - Be CONSERVATIVE â€” only flag as duplicate when very confident
          - False positives are worse than false negatives
          - A feature request is NOT a duplicate of a bug report about the same area
          - NEVER automatically close an issue
          - Maximum 3 related issues in the comment
          PROMPT_EOF
          )

          MAX_RETRIES=2
          RETRY_DELAY=10
          for attempt in $(seq 0 $MAX_RETRIES); do
            if [ "$attempt" -gt 0 ]; then
              echo "::warning::Copilot CLI attempt $attempt failed. Retrying in ${RETRY_DELAY}s..."
              sleep $RETRY_DELAY
              RETRY_DELAY=$((RETRY_DELAY * 2))
            fi
            timeout 300 copilot -p "Repository: ${REPO_NAME}. Issue number: #${ISSUE_NUMBER}. ${PROMPT}" \
              --allow-all-tools --model "$MODEL" && break
            exit_code=$?
            if [ "$attempt" -eq "$MAX_RETRIES" ]; then
              echo "::error::Copilot CLI failed after $((MAX_RETRIES + 1)) attempts (exit code $exit_code) for issue #$ISSUE_NUMBER"
              exit $exit_code
            fi
          done

          echo "âœ… Duplicate check completed for issue #$ISSUE_NUMBER"
