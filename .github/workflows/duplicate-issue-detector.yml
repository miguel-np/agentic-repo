name: ðŸ”Ž Duplicate Issue Detector

on:
  issues:
    types: [opened]
  workflow_call:
    inputs:
      issue_number:
        description: 'Issue number to check for duplicates'
        required: true
        type: string
      issue_title:
        description: 'Issue title'
        required: true
        type: string
      issue_body:
        description: 'Issue body'
        required: false
        type: string
        default: ''
      issue_author:
        description: 'Issue author login'
        required: true
        type: string
      author_filter:
        description: 'Who can trigger this workflow: owner_only, collaborators, or all'
        required: false
        type: string
        default: 'owner_only'
    secrets:
      COPILOT_PAT:
        required: true

permissions:
  contents: read
  issues: write

jobs:
  detect-duplicates:
    name: ðŸ”Ž Check for Duplicate Issues
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ” Verify author is allowed
        id: author_check
        env:
          EVENT_NAME: ${{ github.event_name }}
          REPO_OWNER: ${{ github.repository_owner }}
          REPO_FULL: ${{ github.repository }}
          ISSUE_AUTHOR: ${{ github.event.issue.user.login }}
          INPUT_AUTHOR: ${{ inputs.issue_author }}
          AUTHOR_FILTER: ${{ inputs.author_filter || 'owner_only' }}
          GH_TOKEN: ${{ secrets.COPILOT_PAT || github.token }}
        run: |
          author="$ISSUE_AUTHOR"
          if [ "$EVENT_NAME" = "workflow_call" ]; then
            author="$INPUT_AUTHOR"
          fi

          allowed="false"
          case "$AUTHOR_FILTER" in
            all)
              allowed="true"
              ;;
            collaborators)
              perm=$(gh api "repos/${REPO_FULL}/collaborators/${author}/permission" --jq '.permission' 2>/dev/null || echo "none")
              if [ "$perm" = "admin" ] || [ "$perm" = "write" ] || [ "$perm" = "maintain" ]; then
                allowed="true"
              fi
              ;;
            owner_only|*)
              if [ "$author" = "$REPO_OWNER" ]; then
                allowed="true"
              fi
              ;;
          esac

          echo "allowed=$allowed" >> "$GITHUB_OUTPUT"
          if [ "$allowed" != "true" ]; then
            echo "Skipping: author '$author' not allowed under filter '$AUTHOR_FILTER'."
          fi

      - name: ðŸ“¥ Checkout repository
        if: ${{ steps.author_check.outputs.allowed == 'true' }}
        uses: actions/checkout@v4

      - name: ðŸ“¦ Install GitHub Copilot CLI
        if: ${{ steps.author_check.outputs.allowed == 'true' }}
        run: |
          curl -fsSL https://gh.io/copilot-install | bash
          echo "$HOME/.local/bin" >> $GITHUB_PATH
          echo "--- Copilot CLI version ---"
          $HOME/.local/bin/copilot --version 2>/dev/null || echo "(version flag not supported)"

      - name: ðŸ”Ž Search for duplicate issues
        if: ${{ steps.author_check.outputs.allowed == 'true' }}
        env:
          GH_TOKEN: ${{ secrets.COPILOT_PAT }}
          ISSUE_NUMBER: ${{ inputs.issue_number || github.event.issue.number }}
          ISSUE_TITLE: ${{ inputs.issue_title || github.event.issue.title }}
          ISSUE_BODY: ${{ inputs.issue_body || github.event.issue.body }}
          ISSUE_AUTHOR: ${{ inputs.issue_author || github.event.issue.user.login }}
        run: |
          export PATH="$HOME/.local/bin:$PATH"

          copilot -p "
          You are a Duplicate Issue Detector for the repository '${{ github.repository }}'.
          Your job is to check if a newly opened issue is a duplicate of an existing one
          and flag potential duplicates without being too aggressive.

          NEW ISSUE DETAILS:
          - Number: #$ISSUE_NUMBER
          - Title: $ISSUE_TITLE
          - Body: $ISSUE_BODY
          - Author: @$ISSUE_AUTHOR

          Follow these steps IN ORDER:

          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          STEP 1 â€” EXTRACT KEY TOPICS
          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          - Analyze the new issue title and body.
          - Extract the key topics, technologies, and concepts mentioned.
          - Identify the core problem or request (e.g., 'dark mode support', 'login fails on Safari').
          - Generate 3-5 search queries that would match similar issues.

          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          STEP 2 â€” SEARCH FOR EXISTING ISSUES
          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          - Use the GitHub MCP Server to search for issues in this repository using each
            of the queries generated in Step 1.
          - Search BOTH open AND recently closed issues (closed in the last 90 days).
          - Also search for discussions that may cover the same topic.
          - Collect all potentially related items.

          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          STEP 3 â€” ANALYZE SIMILARITY
          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          For each candidate found, assess the similarity level:

          - ðŸ”´ **High confidence duplicate** (>80% similar):
            Same problem, same context, same expected behavior.
            The new issue adds no new information.

          - ðŸŸ¡ **Likely related** (50-80% similar):
            Same general topic but different angle, additional context,
            or a different aspect of the same problem.

          - ðŸŸ¢ **Loosely related** (20-50% similar):
            Same area of the codebase but different problem.

          Exclude candidates below 20% similarity.

          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          STEP 4 â€” DECIDE AND ACT
          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          Based on the analysis:

          **Case A: High confidence duplicate found (ðŸ”´)**
          Post a comment on issue #$ISSUE_NUMBER:

          > ðŸ”Ž **Possible duplicate detected**
          >
          > This issue appears to be very similar to an existing one:
          > - #EXISTING_NUMBER â€” EXISTING_TITLE (STATUS)
          >
          > If this is indeed a duplicate, please consider closing this issue
          > and adding your input to the original.
          >
          > If this is a different issue, please update the description
          > to clarify how it differs.
          >
          > ---
          > ðŸ¤– *Automated duplicate check by Copilot CLI*

          Then add the label 'duplicate' to issue #$ISSUE_NUMBER if that label exists.

          **Case B: Related issues found (ðŸŸ¡)**
          Post a comment on issue #$ISSUE_NUMBER:

          > ðŸ”Ž **Related issues found**
          >
          > These existing issues may be related:
          > - #NUM1 â€” TITLE1 (STATUS)
          > - #NUM2 â€” TITLE2 (STATUS)
          >
          > You may want to reference or link these for context.
          >
          > ---
          > ðŸ¤– *Automated duplicate check by Copilot CLI*

          Do NOT add the duplicate label in this case.

          **Case C: No duplicates found**
          Do nothing. Do NOT post a comment confirming no duplicates were found
          (it would be noisy). Simply exit silently.

          IMPORTANT GUIDELINES:
          - Be CONSERVATIVE â€” only flag as duplicate when you are very confident
          - False positives (flagging non-duplicates) are worse than false negatives (missing duplicates)
          - Consider that issues may look similar in topic but have different root causes
          - A feature request is NOT a duplicate of a bug report about the same area
          - Recently closed issues ARE valid duplicate targets (the fix may already be in progress)
          - NEVER automatically close an issue â€” only suggest and let the author decide
          - Maximum 3 related issues in the comment to avoid information overload
          " --allow-all-tools --model gpt-5-mini
          exit_code=$?

          if [ $exit_code -ne 0 ]; then
            echo "::error::Copilot CLI failed with exit code $exit_code for issue #$ISSUE_NUMBER"
            exit $exit_code
          fi

          echo "âœ… Duplicate check completed for issue #$ISSUE_NUMBER"
